<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Attack - لعبة space shooter كاملة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06d6a0;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --boss-color: #dc2626;
            --background: #0a0a1a;
            --text-primary: #ffffff;
            --space-blue: #1e3a8a;
            --space-purple: #3730a3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--space-blue), var(--space-purple));
            color: var(--text-primary);
            overflow: hidden;
            direction: rtl;
            user-select: none;
            -webkit-user-select: none;
        }

        /* شاشة التحميل */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* النظام الأساسي للشاشات */
        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--space-blue), var(--space-purple));
        }

        .screen.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .screen-content {
            background: rgba(255,255,255,0.15);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 95%;
            max-height: 95%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        /* الهيدر مع العملات والإعدادات */
        .game-header {
            position: absolute;
            top: 25px;
            left: 25px;
            right: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .player-stats {
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px 25px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            font-size: 1.1em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .header-controls {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.15);
        }

        /* الأيقونات السفلية */
        .bottom-nav {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px 30px;
            border-radius: 30px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .nav-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 20px;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn span {
            font-size: 0.8em;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: var(--primary-color);
            transform: translateY(-8px);
            border-color: var(--primary-color);
        }

        .nav-btn.active {
            background: var(--primary-color);
            transform: scale(1.15);
            border-color: var(--primary-color);
        }

        /* أزرار القائمة */
        .menu-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 15px;
            margin: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 280px;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .menu-btn:hover {
            transform: translateY(-5px);
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            box-shadow: 0 12px 25px rgba(99, 102, 241, 0.5);
        }

        .menu-btn.secondary {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .menu-btn.secondary:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }

        /* شبكة المستويات */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 15px;
            margin: 30px 0;
            max-width: 600px;
        }

        .level-btn {
            width: 90px;
            height: 90px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .level-btn.locked {
            background: #4b5563;
            cursor: not-allowed;
        }

        .level-btn.completed {
            background: linear-gradient(135deg, var(--accent-color), #059669);
        }

        .level-btn.current {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            animation: pulse 2s infinite;
        }

        .level-btn.boss {
            background: linear-gradient(135deg, var(--boss-color), #b91c1c);
            border: 3px solid #fbbf24;
        }

        .level-reward {
            font-size: 0.8em;
            margin-top: 8px;
            color: #fbbf24;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 12px 30px rgba(139, 92, 246, 0.6); }
        }

        .level-btn:hover:not(.locked) {
            transform: scale(1.15);
        }

        /* شاشة اللعبة */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .game-ui > * {
            pointer-events: auto;
        }

        .game-stats {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(0,0,0,0.85);
            padding: 20px 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            font-size: 1.2em;
            font-weight: bold;
        }

        .game-stats div {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-bar {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .game-controls {
            position: absolute;
            bottom: 25px;
            right: 25px;
            display: flex;
            gap: 15px;
        }

        /* مؤشر الإطلاق التلقائي */
        .auto-fire-indicator {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
            backdrop-filter: blur(15px);
            display: none;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        /* تحذير البوس */
        .boss-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--boss-color), #b91c1c);
            color: white;
            padding: 30px 60px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            animation: bossWarning 2s ease-in-out;
            display: none;
            border: 4px solid #fbbf24;
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.5);
        }

        @keyframes bossWarning {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* تأثيرات النص العائم */
        .floating-text {
            position: absolute;
            color: #fbbf24;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 100;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-80px); opacity: 0; }
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .screen-content {
                padding: 25px;
                margin: 15px;
            }
            
            .level-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            .level-btn {
                width: 75px;
                height: 75px;
                font-size: 1.3em;
            }
            
            .bottom-nav {
                padding: 15px 20px;
            }
            
            .nav-btn {
                width: 65px;
                height: 65px;
                font-size: 1.5em;
            }
            
            .nav-btn span {
                font-size: 0.7em;
            }
            
            .menu-btn {
                min-width: 250px;
                padding: 18px 35px;
                font-size: 1.2em;
            }
            
            .health-bar {
                width: 300px;
            }
            
            .game-stats {
                font-size: 1.1em;
                padding: 15px 25px;
            }
        }

        /* إعدادات اللغة */
        .language-selector {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            justify-content: center;
        }

        .lang-btn {
            padding: 15px 30px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
        }

        .lang-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        /* صور اللعبة */
        .game-image {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* النجوم المتحركة */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- النجوم المتحركة -->
    <div class="stars" id="starsContainer"></div>

    <!-- شاشة التحميل -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loader"></div>
            <h2 style="font-size: 2em; margin-bottom: 15px;">🚀 جاري تحميل Galaxy Attack...</h2>
            <p style="font-size: 1.2em;">إعداد الفضاء للقتال</p>
        </div>
    </div>

    <!-- الشاشة الرئيسية -->
    <div id="startScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💰</span>
                    <span id="totalCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💎</span>
                    <span id="totalGems">50</span>
                </div>
                <div class="stat-item">
                    <span style="font-size: 1.3em;">⭐</span>
                    <span id="playerLevel">1</span>
                </div>
            </div>
            <div class="header-controls">
                <button class="icon-btn" onclick="showScreen('settingsScreen')">⚙️</button>
                <button class="icon-btn" onclick="toggleSound()">🔊</button>
            </div>
        </div>

        <div class="screen-content">
            <h1 style="font-size: 4em; margin-bottom: 30px; background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 8px 20px rgba(0,0,0,0.3);">🌌 Galaxy Attack</h1>
            
            <div class="main-menu">
                <button class="menu-btn" onclick="showScreen('levelSelectScreen')">
                    <span style="font-size: 1.4em;">🎮</span>
                    <span data-lang="ar">بدء المغامرة</span>
                    <span data-lang="en" style="display: none;">Start Adventure</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('shipsScreen')">
                    <span style="font-size: 1.4em;">🚀</span>
                    <span data-lang="ar">الأسطول الفضائي</span>
                    <span data-lang="en" style="display: none;">Space Fleet</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('upgradesScreen')">
                    <span style="font-size: 1.4em;">⚡</span>
                    <span data-lang="ar">مركز الترقيات</span>
                    <span data-lang="en" style="display: none;">Upgrade Center</span>
                </button>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showScreen('startScreen')">
                <span>🏠</span>
                <span data-lang="ar">الرئيسية</span>
                <span data-lang="en" style="display: none;">Home</span>
            </button>
            <button class="nav-btn" onclick="showScreen('shipsScreen')">
                <span>🚀</span>
                <span data-lang="ar">الأسطول</span>
                <span data-lang="en" style="display: none;">Fleet</span>
            </button>
            <button class="nav-btn" onclick="showScreen('upgradesScreen')">
                <span>⚡</span>
                <span data-lang="ar">الترقيات</span>
                <span data-lang="en" style="display: none;">Upgrades</span>
            </button>
        </div>
    </div>

    <!-- شاشة اختيار المستوى -->
    <div id="levelSelectScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💰</span>
                    <span id="levelsCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💎</span>
                    <span id="levelsGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">←</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar" style="font-size: 2.5em; margin-bottom: 20px;">🎯 اختر المستوى</h2>
            <h2 data-lang="en" style="display: none; font-size: 2.5em; margin-bottom: 20px;">🎯 Select Level</h2>
            <div class="level-grid" id="levelGrid">
                <!-- المستويات سيتم إنشاؤها بالجافاسكريبت -->
            </div>
        </div>
    </div>

    <!-- شاشة الأسطول -->
    <div id="shipsScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💰</span>
                    <span id="shipsCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💎</span>
                    <span id="shipsGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">←</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar" style="font-size: 2.5em; margin-bottom: 20px;">🚀 الأسطول الفضائي</h2>
            <h2 data-lang="en" style="display: none; font-size: 2.5em; margin-bottom: 20px;">🚀 Space Fleet</h2>
            <div id="shipsContainer" style="margin: 25px 0; display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <!-- السفن سيتم إنشاؤها بالجافاسكريبت -->
            </div>
        </div>
    </div>

    <!-- شاشة الترقيات -->
    <div id="upgradesScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💰</span>
                    <span id="upgradesCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span style="font-size: 1.3em;">💎</span>
                    <span id="upgradesGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">←</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar" style="font-size: 2.5em; margin-bottom: 20px;">⚡ مركز الترقيات</h2>
            <h2 data-lang="en" style="display: none; font-size: 2.5em; margin-bottom: 20px;">⚡ Upgrade Center</h2>
            <div id="upgradesContainer" style="margin: 25px 0; display: grid; gap: 20px;">
                <!-- الترقيات سيتم إنشاؤها بالجافاسكريبت -->
            </div>
        </div>
    </div>

    <!-- شاشة اللعبة -->
    <div id="gameScreen" class="screen">
        <canvas id="gameCanvas"></canvas>
        
        <div class="game-ui">
            <div class="game-stats">
                <div>
                    <span data-lang="ar">المستوى:</span>
                    <span data-lang="en" style="display: none;">Level:</span>
                    <span id="currentLevel" style="color: #fbbf24;">1</span>
                </div>
                <div>
                    <span data-lang="ar">النقاط:</span>
                    <span data-lang="en" style="display: none;">Score:</span>
                    <span id="currentScore" style="color: #fbbf24;">0</span>
                </div>
                <div>
                    <span>💰</span>
                    <span id="gameCoins" style="color: #fbbf24;">0</span>
                    <span style="margin: 0 10px;">|</span>
                    <span>💎</span>
                    <span id="gameGems" style="color: #fbbf24;">0</span>
                </div>
            </div>
            
            <div class="health-bar">
                <div class="health-fill" id="healthFill" style="width: 100%;"></div>
            </div>
            
            <div class="game-controls">
                <button class="icon-btn" onclick="pauseGame()">⏸️</button>
                <button class="icon-btn" onclick="showScreen('startScreen')">🏠</button>
            </div>

            <!-- مؤشر الإطلاق التلقائي -->
            <div class="auto-fire-indicator" id="autoFireIndicator">
                <span data-lang="ar">🔥 الإطلاق التلقائي مفعل</span>
                <span data-lang="en" style="display: none;">🔥 Auto Fire Active</span>
            </div>

            <!-- تحذير البوس -->
            <div class="boss-warning" id="bossWarning">
                <span data-lang="ar">⚠️ خطر! البوس قادم</span>
                <span data-lang="en" style="display: none;">⚠️ Danger! Boss Incoming</span>
            </div>
        </div>
    </div>

    <!-- شاشة الإعدادات -->
    <div id="settingsScreen" class="screen">
        <div class="game-header">
            <button class="icon-btn" onclick="showScreen('startScreen')">←</button>
        </div>
        <div class="screen-content">
            <h2 data-lang="ar" style="font-size: 2.5em; margin-bottom: 20px;">⚙️ الإعدادات</h2>
            <h2 data-lang="en" style="display: none; font-size: 2.5em; margin-bottom: 20px;">⚙️ Settings</h2>
            
            <div class="language-selector">
                <button class="lang-btn active" onclick="changeLanguage('ar')">العربية</button>
                <button class="lang-btn" onclick="changeLanguage('en')">English</button>
            </div>
            
            <div style="text-align: right; margin: 30px 0;">
                <div style="margin: 20px 0;">
                    <label style="font-size: 1.3em; display: block; margin-bottom: 10px;">🔊 
                        <span data-lang="ar">صوت المؤثرات</span>
                        <span data-lang="en" style="display: none;">SFX Volume</span>
                    </label>
                    <input type="range" min="0" max="100" value="80" id="sfxVolume" style="width: 300px; height: 15px;">
                </div>
                <div style="margin: 20px 0;">
                    <label style="font-size: 1.3em; display: block; margin-bottom: 10px;">🎵 
                        <span data-lang="ar">صوت الموسيقى</span>
                        <span data-lang="en" style="display: none;">Music Volume</span>
                    </label>
                    <input type="range" min="0" max="100" value="60" id="musicVolume" style="width: 300px; height: 15px;">
                </div>
            </div>
            <button class="menu-btn" onclick="resetGame()">
                <span data-lang="ar">🔄 إعادة تعيين اللعبة</span>
                <span data-lang="en" style="display: none;">🔄 Reset Game</span>
            </button>
        </div>
    </div>

    <!-- عناصر الصوت -->
    <audio id="shootSound" preload="auto" src="sounds/shoot.wav"></audio>
    <audio id="explosionSound" preload="auto" src="sounds/explosion.wav"></audio>
    <audio id="coinSound" preload="auto" src="sounds/coin.wav"></audio>
    <audio id="upgradeSound" preload="auto"></audio>
    <audio id="enemyStopSound" preload="auto"></audio>
    <audio id="backgroundMusic" loop preload="auto" src="sounds/background.mp3"></audio>
    <audio id="bossSound" preload="auto"></audio>

    <script>
        // ===== نظام النجوم المتحركة =====
        function createStars() {
            const starsContainer = document.getElementById('starsContainer');
            starsContainer.innerHTML = '';
            
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.setProperty('--duration', Math.random() * 3 + 2 + 's');
                star.style.animationDelay = Math.random() * 5 + 's';
                starsContainer.appendChild(star);
            }
        }

        // ===== بيانات اللعبة =====
        let gameData = {
            coins: 1000,
            gems: 50,
            currentLevel: 1,
            unlockedLevels: 1,
            selectedShip: 'basic',
            upgrades: {
                weapon: 1,
                fireRate: 1,
                shield: 1,
                health: 1,
                doubleShot: false
            },
            ships: {
                basic: { unlocked: true, level: 1 },
                fighter: { unlocked: false, level: 1 },
                tank: { unlocked: false, level: 1 },
                sniper: { unlocked: false, level: 1 }
            },
            settings: {
                sfxVolume: 80,
                musicVolume: 60,
                soundEnabled: true,
                language: 'ar'
            },
            completedLevels: []
        };

        // ===== نظام اللغة =====
        const translations = {
            ar: {
                startAdventure: "بدء المغامرة",
                spaceFleet: "الأسطول الفضائي", 
                upgradeCenter: "مركز الترقيات",
                selectLevel: "اختر المستوى",
                level: "المستوى",
                score: "النقاط",
                autoFireActive: "الإطلاق التلقائي مفعل",
                bossWarning: "⚠️ خطر! البوس قادم",
                settings: "الإعدادات",
                sfxVolume: "صوت المؤثرات",
                musicVolume: "صوت الموسيقى",
                resetGame: "إعادة تعيين اللعبة",
                home: "الرئيسية",
                fleet: "الأسطول",
                upgrades: "الترقيات"
            },
            en: {
                startAdventure: "Start Adventure",
                spaceFleet: "Space Fleet",
                upgradeCenter: "Upgrade Center", 
                selectLevel: "Select Level",
                level: "Level",
                score: "Score",
                autoFireActive: "Auto Fire Active",
                bossWarning: "⚠️ Danger! Boss Incoming",
                settings: "Settings",
                sfxVolume: "SFX Volume",
                musicVolume: "Music Volume",
                resetGame: "Reset Game",
                home: "Home",
                fleet: "Fleet",
                upgrades: "Upgrades"
            }
        };

        // ===== نظام الصوت =====
        const SoundManager = {
            init() {
                console.log('🔊 تهيئة نظام الصوت...');
                this.setupSoundControls();
            },

            playShoot() {
                if (!gameData.settings.soundEnabled) return;
                this.playSound('shootSound');
            },

            playExplosion() {
                if (!gameData.settings.soundEnabled) return;
                this.playSound('explosionSound');
            },

            playCoin() {
                if (!gameData.settings.soundEnabled) return;
                this.playSound('coinSound');
            },

            playSound(soundId) {
                try {
                    const audio = document.getElementById(soundId);
                    if (audio) {
                        audio.volume = gameData.settings.sfxVolume / 100;
                        audio.currentTime = 0;
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => console.log(`لم يتم تشغيل ${soundId}`));
                        }
                    }
                } catch (error) {
                    console.log(`خطأ في ${soundId}:`, error);
                }
            },

            playBackgroundMusic() {
                if (!gameData.settings.soundEnabled) return;
                try {
                    const music = document.getElementById('backgroundMusic');
                    if (music) {
                        music.volume = gameData.settings.musicVolume / 100;
                        music.play().catch(e => console.log('لم يتم تشغيل الموسيقى'));
                    }
                } catch (error) {
                    console.log('خطأ في الموسيقى:', error);
                }
            },

            stopBackgroundMusic() {
                const music = document.getElementById('backgroundMusic');
                if (music) {
                    music.pause();
                    music.currentTime = 0;
                }
            },

            updateMusicVolume() {
                const music = document.getElementById('backgroundMusic');
                if (music) {
                    music.volume = gameData.settings.musicVolume / 100;
                }
            },

            setupSoundControls() {
                const sfxSlider = document.getElementById('sfxVolume');
                const musicSlider = document.getElementById('musicVolume');
                
                if (sfxSlider) {
                    sfxSlider.value = gameData.settings.sfxVolume;
                    sfxSlider.addEventListener('input', (e) => {
                        gameData.settings.sfxVolume = e.target.value;
                    });
                }
                
                if (musicSlider) {
                    musicSlider.value = gameData.settings.musicVolume;
                    musicSlider.addEventListener('input', (e) => {
                        gameData.settings.musicVolume = e.target.value;
                        this.updateMusicVolume();
                    });
                }
            },

            toggleSound() {
                gameData.settings.soundEnabled = !gameData.settings.soundEnabled;
                const btn = document.querySelector('.icon-btn[onclick="toggleSound()"]');
                if (btn) {
                    btn.textContent = gameData.settings.soundEnabled ? '🔊' : '🔇';
                }
                
                if (gameData.settings.soundEnabled) {
                    this.playBackgroundMusic();
                } else {
                    this.stopBackgroundMusic();
                }
            }
        };

        // ===== متغيرات اللعبة =====
        let game = {
            canvas: null,
            ctx: null,
            player: null,
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            loot: [],
            score: 0,
            isPaused: false,
            lastShot: 0,
            isTouching: false,
            touchX: 0,
            touchY: 0,
            enemySpawnInterval: null,
            autoFireInterval: null,
            boss: null,
            bossActive: false,
            backgroundStars: []
        };

        // ===== دوال النظام الأساسي =====
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.add('active');
                updateScreenContent(screenName);
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (screenName === 'startScreen') {
                document.querySelector('.nav-btn').classList.add('active');
            }
        }

        function updateScreenContent(screenName) {
            updateCurrencyDisplay();
            
            switch(screenName) {
                case 'levelSelectScreen':
                    generateLevels();
                    break;
                case 'shipsScreen':
                    generateShips();
                    break;
                case 'upgradesScreen':
                    generateUpgrades();
                    break;
                case 'gameScreen':
                    startGame();
                    break;
            }
        }

        function updateCurrencyDisplay() {
            document.querySelectorAll('#totalCoins, #levelsCoins, #shipsCoins, #upgradesCoins, #gameCoins').forEach(el => {
                if(el) el.textContent = gameData.coins;
            });
            document.querySelectorAll('#totalGems, #levelsGems, #shipsGems, #upgradesGems, #gameGems').forEach(el => {
                if(el) el.textContent = gameData.gems;
            });
            document.getElementById('playerLevel').textContent = gameData.currentLevel;
        }

        function changeLanguage(lang) {
            gameData.settings.language = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (lang === 'ar' ? 'العربية' : 'English')) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('[data-lang]').forEach(element => {
                if (element.getAttribute('data-lang') === lang) {
                    element.style.display = 'inline';
                } else {
                    element.style.display = 'none';
                }
            });
            
            generateLevels();
            generateShips();
            generateUpgrades();
        }

        // ===== إنشاء المحتوى =====
        function generateLevels() {
            const levelGrid = document.getElementById('levelGrid');
            if(!levelGrid) return;
            
            levelGrid.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const levelBtn = document.createElement('button');
                levelBtn.className = 'level-btn';
                
                const baseReward = 50;
                const reward = baseReward * Math.pow(1.5, Math.floor((i-1)/5));
                
                if (i % 10 === 0) {
                    levelBtn.classList.add('boss');
                    levelBtn.innerHTML = `👹<div class="level-reward">${Math.floor(reward)}💰</div>`;
                } else {
                    levelBtn.innerHTML = `${i}<div class="level-reward">${Math.floor(reward)}💰</div>`;
                }
                
                if (i > gameData.unlockedLevels) {
                    levelBtn.classList.add('locked');
                    levelBtn.innerHTML = '🔒';
                } else if (i === gameData.currentLevel) {
                    levelBtn.classList.add('current');
                } else if (gameData.completedLevels.includes(i)) {
                    levelBtn.classList.add('completed');
                }
                
                if (i <= gameData.unlockedLevels) {
                    levelBtn.onclick = () => startLevel(i);
                }
                
                levelGrid.appendChild(levelBtn);
            }
        }

        function generateShips() {
            const shipsContainer = document.getElementById('shipsContainer');
            if(!shipsContainer) return;
            
            shipsContainer.innerHTML = '';
            
            const ships = [
                { id: 'basic', name: '🚀 الطائرة الأساسية', price: 0, stats: '❤️ 100 ⚡ 8 💥 25' },
                { id: 'fighter', name: '🛸 المقاتلة السريعة', price: 500, stats: '❤️ 80 ⚡ 12 💥 20' },
                { id: 'tank', name: '🛡️ الدبابة الفضائية', price: 800, stats: '❤️ 200 ⚡ 5 💥 35' },
                { id: 'sniper', name: '🎯 القناصة', price: 1200, stats: '❤️ 90 ⚡ 7 💥 60' }
            ];
            
            ships.forEach(ship => {
                const isUnlocked = gameData.ships[ship.id].unlocked;
                const isSelected = gameData.selectedShip === ship.id;
                
                const shipDiv = document.createElement('div');
                shipDiv.style.background = isSelected ? 'rgba(99, 102, 241, 0.25)' : 'rgba(255,255,255,0.15)';
                shipDiv.style.padding = '25px';
                shipDiv.style.borderRadius = '20px';
                shipDiv.style.border = isSelected ? '3px solid #6366f1' : '2px solid rgba(255,255,255,0.3)';
                shipDiv.style.textAlign = 'center';
                shipDiv.style.backdropFilter = 'blur(10px)';
                
                shipDiv.innerHTML = `
                    <h3 style="margin-bottom: 15px; font-size: 1.4em;">${ship.name}</h3>
                    <p style="color: #e5e7eb; margin-bottom: 15px; font-size: 1.1em;">${ship.stats}</p>
                    ${!isUnlocked ? 
                        `<p style="color: #fbbf24; margin-bottom: 15px; font-size: 1.1em; font-weight: bold;">السعر: ${ship.price} 💰</p>
                         <button class="menu-btn" onclick="buyShip('${ship.id}', ${ship.price})" 
                                 style="padding: 12px 25px; font-size: 1.1em; min-width: auto;"
                                 ${gameData.coins >= ship.price ? '' : 'disabled'}>
                             شراء
                         </button>` : 
                        `<button class="menu-btn" onclick="selectShip('${ship.id}')" 
                                 style="padding: 12px 25px; font-size: 1.1em; min-width: auto; background: ${isSelected ? '#10b981' : '#6366f1'};"
                                 ${isSelected ? 'disabled' : ''}>
                             ${isSelected ? 'محددة' : 'اختيار'}
                         </button>`
                    }
                `;
                
                shipsContainer.appendChild(shipDiv);
            });
        }

        function generateUpgrades() {
            const upgradesContainer = document.getElementById('upgradesContainer');
            if(!upgradesContainer) return;
            
            upgradesContainer.innerHTML = '';
            
            const upgrades = [
                { id: 'weapon', name: '💥 قوة السلاح', level: gameData.upgrades.weapon, price: 50, desc: 'يزيد قوة الضرر' },
                { id: 'fireRate', name: '🎯 سرعة الطلقات', level: gameData.upgrades.fireRate, price: 75, desc: 'يزيد سرعة الإطلاق' },
                { id: 'shield', name: '🛡️ درع الطاقة', level: gameData.upgrades.shield, price: 100, desc: 'يقلل الضرر الواقع' },
                { id: 'health', name: '❤️ تعزيز الصحة', level: gameData.upgrades.health, price: 150, desc: 'يزيد الصحة القصوى' }
            ];
            
            if (gameData.upgrades.doubleShot) {
                upgrades.push({
                    id: 'doubleShot',
                    name: '🔫 طلقة مزدوجة',
                    level: 'مفعل',
                    price: 0,
                    desc: 'إطلاق رصاصتين في نفس الوقت'
                });
            }
            
            upgrades.forEach(upgrade => {
                const upgradeDiv = document.createElement('div');
                upgradeDiv.style.background = 'rgba(255,255,255,0.15)';
                upgradeDiv.style.padding = '25px';
                upgradeDiv.style.borderRadius = '20px';
                upgradeDiv.style.display = 'flex';
                upgradeDiv.style.justifyContent = 'space-between';
                upgradeDiv.style.alignItems = 'center';
                upgradeDiv.style.flexWrap = 'wrap';
                upgradeDiv.style.gap = '20px';
                upgradeDiv.style.backdropFilter = 'blur(10px)';
                upgradeDiv.style.border = '2px solid rgba(255,255,255,0.2)';
                
                const upgradeInfo = document.createElement('div');
                upgradeInfo.style.textAlign = 'right';
                upgradeInfo.style.flex = '1';
                upgradeInfo.innerHTML = `
                    <h4 style="margin-bottom: 10px; font-size: 1.3em;">${upgrade.name}</h4>
                    <p style="color: #e5e7eb; font-size: 1.1em; margin-bottom: 10px;">${upgrade.desc}</p>
                    <p style="color: #fbbf24; font-size: 1.1em; font-weight: bold;">المستوى: ${upgrade.level} ${upgrade.price > 0 ? '| السعر: ' + upgrade.price + ' 💰' : ''}</p>
                `;
                
                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'menu-btn';
                upgradeBtn.style.padding = '12px 25px';
                upgradeBtn.style.minWidth = 'auto';
                upgradeBtn.style.fontSize = '1.1em';
                
                if (upgrade.id === 'doubleShot') {
                    upgradeBtn.textContent = 'مفعل';
                    upgradeBtn.disabled = true;
                    upgradeBtn.style.background = '#10b981';
                } else {
                    upgradeBtn.textContent = 'ترقية';
                    upgradeBtn.onclick = () => buyUpgrade(upgrade.id, upgrade.price);
                    upgradeBtn.disabled = gameData.coins < upgrade.price;
                }
                
                upgradeDiv.appendChild(upgradeInfo);
                upgradeDiv.appendChild(upgradeBtn);
                upgradesContainer.appendChild(upgradeDiv);
            });
        }

        // ===== دوال اللعبة =====
        function selectShip(shipId) {
            gameData.selectedShip = shipId;
            generateShips();
            showFloatingText('✓ تم اختيار الطائرة!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
        }

        function buyShip(shipId, price) {
            if (gameData.coins >= price) {
                gameData.coins -= price;
                gameData.ships[shipId].unlocked = true;
                gameData.selectedShip = shipId;
                updateCurrencyDisplay();
                generateShips();
                showFloatingText('✓ تم شراء الطائرة!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
            }
        }

        function buyUpgrade(upgradeId, price) {
            if (gameData.coins >= price) {
                gameData.coins -= price;
                gameData.upgrades[upgradeId]++;
                updateCurrencyDisplay();
                generateUpgrades();
                showFloatingText('✓ تمت الترقية!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
            }
        }

        function startLevel(level) {
            gameData.currentLevel = level;
            showScreen('gameScreen');
        }

        // ===== محرك اللعبة الرئيسي مع التحسينات =====
        function startGame() {
            console.log('🎮 بدء اللعبة...');
            
            try {
                game.canvas = document.getElementById('gameCanvas');
                game.ctx = game.canvas.getContext('2d');
                
                game.canvas.width = window.innerWidth;
                game.canvas.height = window.innerHeight;
                
                resetGameState();
                setupPlayer();
                setupControls();
                createBackgroundStars();
                gameLoop();
                startEnemySpawning();
                SoundManager.playBackgroundMusic();
                
                if (gameData.currentLevel % 10 === 0) {
                    setTimeout(() => {
                        spawnBoss();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('❌ خطأ في بدء اللعبة:', error);
                alert('حدث خطأ في بدء اللعبة. يرجى تحديث الصفحة.');
            }
        }

        function resetGameState() {
            if (game.enemySpawnInterval) clearInterval(game.enemySpawnInterval);
            if (game.autoFireInterval) clearInterval(game.autoFireInterval);
            
            game.enemies = [];
            game.bullets = [];
            game.enemyBullets = [];
            game.particles = [];
            game.loot = [];
            game.score = 0;
            game.isPaused = false;
            game.lastShot = 0;
            game.isTouching = false;
            game.boss = null;
            game.bossActive = false;
            game.backgroundStars = [];
            
            document.getElementById('currentLevel').textContent = gameData.currentLevel;
            document.getElementById('currentScore').textContent = '0';
            document.getElementById('gameCoins').textContent = '0';
            document.getElementById('gameGems').textContent = '0';
            document.getElementById('healthFill').style.width = '100%';
            
            document.getElementById('autoFireIndicator').style.display = 'none';
            document.getElementById('bossWarning').style.display = 'none';
        }

        function createBackgroundStars() {
            for (let i = 0; i < 200; i++) {
                game.backgroundStars.push({
                    x: Math.random() * game.canvas.width,
                    y: Math.random() * game.canvas.height,
                    size: Math.random() * 3 + 1,
                    speed: Math.random() * 2 + 0.5
                });
            }
        }

        function setupPlayer() {
            const doubleShotBonus = gameData.upgrades.doubleShot ? 1.5 : 1;
            
            // زيادة حجم الطائرة بشكل كبير
            game.player = {
                x: game.canvas.width / 2 - 40, // زيادة العرض
                y: game.canvas.height - 150,   // رفع الطائرة أعلى
                width: 80,  // زيادة الحجم
                height: 80, // زيادة الحجم
                speed: 8,
                health: 100 + (gameData.upgrades.health * 25),
                maxHealth: 100 + (gameData.upgrades.health * 25),
                color: '#6366f1',
                lastShot: 0,
                fireRate: Math.max(100, 300 - (gameData.upgrades.fireRate * 20)) * doubleShotBonus,
                damage: 25 + (gameData.upgrades.weapon * 15),
                hasDoubleShot: gameData.upgrades.doubleShot
            };
        }

        function setupControls() {
            game.canvas.addEventListener('touchstart', handleTouchStart);
            game.canvas.addEventListener('touchmove', handleTouchMove);
            game.canvas.addEventListener('touchend', handleTouchEnd);
            
            game.canvas.addEventListener('mousedown', handleMouseDown);
            game.canvas.addEventListener('mousemove', handleMouseMove);
            game.canvas.addEventListener('mouseup', handleMouseUp);
        }

        function handleTouchStart(e) {
            e.preventDefault();
            game.isTouching = true;
            const touch = e.touches[0];
            updatePlayerPosition(touch.clientX, touch.clientY);
            startAutoFire();
            document.getElementById('autoFireIndicator').style.display = 'block';
        }

        function handleTouchMove(e) {
            if (!game.isTouching) return;
            e.preventDefault();
            const touch = e.touches[0];
            updatePlayerPosition(touch.clientX, touch.clientY);
        }

        function handleTouchEnd(e) {
            game.isTouching = false;
            stopAutoFire();
            document.getElementById('autoFireIndicator').style.display = 'none';
        }

        function handleMouseDown(e) {
            game.isTouching = true;
            updatePlayerPosition(e.clientX, e.clientY);
            startAutoFire();
            document.getElementById('autoFireIndicator').style.display = 'block';
        }

        function handleMouseMove(e) {
            if (!game.isTouching) return;
            updatePlayerPosition(e.clientX, e.clientY);
        }

        function handleMouseUp(e) {
            game.isTouching = false;
            stopAutoFire();
            document.getElementById('autoFireIndicator').style.display = 'none';
        }

        function updatePlayerPosition(clientX, clientY) {
            const rect = game.canvas.getBoundingClientRect();
            game.touchX = clientX - rect.left;
            game.touchY = clientY - rect.top;
            
            game.player.x = game.touchX - game.player.width / 2;
            game.player.y = game.touchY - game.player.height / 2;
            
            game.player.x = Math.max(0, Math.min(game.canvas.width - game.player.width, game.player.x));
            game.player.y = Math.max(0, Math.min(game.canvas.height - game.player.height, game.player.y));
        }

        function startAutoFire() {
            shoot();
            game.autoFireInterval = setInterval(() => {
                if (game.isTouching && !game.isPaused) shoot();
            }, game.player.fireRate);
        }

        function stopAutoFire() {
            if (game.autoFireInterval) {
                clearInterval(game.autoFireInterval);
                game.autoFireInterval = null;
            }
        }

        function shoot() {
            if (Date.now() - game.player.lastShot > game.player.fireRate) {
                if (game.player.hasDoubleShot) {
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2 - 20,
                        y: game.player.y,
                        width: 8,
                        height: 20,
                        speed: 12,
                        damage: game.player.damage,
                        color: '#4fc3f7'
                    });
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2 + 12,
                        y: game.player.y,
                        width: 8,
                        height: 20,
                        speed: 12,
                        damage: game.player.damage,
                        color: '#4fc3f7'
                    });
                } else {
                    game.bullets.push({
                        x: game.player.x + game.player.width / 2 - 4,
                        y: game.player.y,
                        width: 8,
                        height: 20,
                        speed: 12,
                        damage: game.player.damage,
                        color: '#4fc3f7'
                    });
                }

                game.player.lastShot = Date.now();
                SoundManager.playShoot();
            }
        }

        function gameLoop() {
            if (game.isPaused) {
                requestAnimationFrame(gameLoop);
                return;
            }

            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            updateBackgroundStars();
            updateBullets();
            updateEnemies();
            updateBoss();
            updateEnemyBullets();
            updateParticles();
            updateLoot();
            checkCollisions();
        }

        function updateBackgroundStars() {
            game.backgroundStars.forEach(star => {
                star.y += star.speed;
                if (star.y > game.canvas.height) {
                    star.y = -star.size;
                    star.x = Math.random() * game.canvas.width;
                }
            });
        }

        function updateBullets() {
            game.bullets = game.bullets.filter(bullet => {
                bullet.y -= bullet.speed;
                return bullet.y > -bullet.height;
            });
        }

        function updateEnemies() {
            if (game.bossActive) return;
            
            game.enemies.forEach(enemy => {
                if (enemy.stopped) {
                    enemy.stopTimer--;
                    if (enemy.stopTimer <= 0) {
                        enemy.stopped = false;
                        enemy.speed = enemy.originalSpeed;
                    }
                } else {
                    enemy.y += enemy.speed;
                    
                    if (!enemy.hasStopped && enemy.y >= game.canvas.height / 3) {
                        enemy.stopped = true;
                        enemy.hasStopped = true;
                        enemy.stopTimer = 300;
                        enemy.speed = 0;
                    }
                }
                
                if (!enemy.stopped && Math.random() < 0.005) {
                    game.enemyBullets.push({
                        x: enemy.x + enemy.width / 2 - 4,
                        y: enemy.y + enemy.height,
                        width: 8,
                        height: 20,
                        speed: 6,
                        damage: 10,
                        color: '#ef4444'
                    });
                }
            });

            game.enemies = game.enemies.filter(enemy => enemy.y < game.canvas.height);
        }

        function spawnEnemy() {
            const level = gameData.currentLevel;
            const difficulty = 1 + (level * 0.15);
            
            const enemyTypes = [
                { width: 70, height: 70, health: 30, speed: 1, color: '#ef4444', value: 10 },
                { width: 60, height: 60, health: 20, speed: 1.5, color: '#f59e0b', value: 15 },
                { width: 90, height: 90, health: 50, speed: 0.8, color: '#8b5cf6', value: 25 }
            ];
            
            const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            game.enemies.push({
                x: Math.random() * (game.canvas.width - type.width),
                y: -type.height,
                width: type.width,  // زيادة حجم الأعداء
                height: type.height, // زيادة حجم الأعداء
                health: type.health * difficulty,
                maxHealth: type.health * difficulty,
                speed: type.speed * (1 + (level * 0.02)),
                originalSpeed: type.speed * (1 + (level * 0.02)),
                color: type.color,
                value: Math.floor(type.value * difficulty),
                stopped: false,
                hasStopped: false,
                stopTimer: 0
            });
        }

        function startEnemySpawning() {
            if (game.bossActive) return;
            
            if(game.enemySpawnInterval) clearInterval(game.enemySpawnInterval);
            
            const spawnRate = Math.max(500, 2000 - (gameData.currentLevel * 50));
            
            game.enemySpawnInterval = setInterval(() => {
                if (!game.isPaused && !game.bossActive) spawnEnemy();
            }, spawnRate);
        }

        function updateBoss() {
            if (!game.bossActive || !game.boss) return;
            
            game.boss.x += game.boss.speedX;
            game.boss.y += game.boss.speedY;
            
            if (game.boss.x <= 0 || game.boss.x + game.boss.width >= game.canvas.width) {
                game.boss.speedX *= -1;
            }
            if (game.boss.y <= 50 || game.boss.y + game.boss.height >= game.canvas.height / 2) {
                game.boss.speedY *= -1;
            }
            
            game.boss.lastShot--;
            if (game.boss.lastShot <= 0) {
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    game.enemyBullets.push({
                        x: game.boss.x + game.boss.width / 2 - 6,
                        y: game.boss.y + game.boss.height / 2,
                        width: 12,
                        height: 12,
                        speed: 4,
                        damage: 20,
                        color: '#dc2626',
                        vx: Math.cos(angle) * 4,
                        vy: Math.sin(angle) * 4
                    });
                }
                game.boss.lastShot = 60;
            }
        }

        function spawnBoss() {
            game.bossActive = true;
            const level = gameData.currentLevel;
            const difficulty = 1 + (level * 0.15);
            
            const bossWarning = document.getElementById('bossWarning');
            bossWarning.style.display = 'block';
            
            const arText = bossWarning.querySelector('[data-lang="ar"]');
            const enText = bossWarning.querySelector('[data-lang="en"]');
            if (gameData.settings.language === 'ar') {
                arText.style.display = 'inline';
                enText.style.display = 'none';
            } else {
                arText.style.display = 'none';
                enText.style.display = 'inline';
            }
            
            setTimeout(() => {
                bossWarning.style.display = 'none';
            }, 3000);
            
            // زيادة حجم البوس بشكل كبير
            game.boss = {
                x: game.canvas.width / 2 - 120,
                y: 50,
                width: 240,  // زيادة كبيرة في الحجم
                height: 160, // زيادة كبيرة في الحجم
                health: Math.floor(500 * difficulty),
                maxHealth: Math.floor(500 * difficulty),
                speedX: 2 + (level * 0.1),
                speedY: 1 + (level * 0.05),
                color: '#dc2626',
                value: Math.floor(500 * difficulty),
                lastShot: 0,
                rewardGiven: false
            };
            
            if (game.enemySpawnInterval) clearInterval(game.enemySpawnInterval);
        }

        function updateEnemyBullets() {
            game.enemyBullets = game.enemyBullets.filter(bullet => {
                if (bullet.vx && bullet.vy) {
                    bullet.x += bullet.vx;
                    bullet.y += bullet.vy;
                } else {
                    bullet.y += bullet.speed;
                }
                return bullet.y < game.canvas.height && bullet.y > -bullet.height && 
                       bullet.x > -bullet.width && bullet.x < game.canvas.width + bullet.width;
            });
        }

        function updateParticles() {
            game.particles = game.particles.filter(particle => {
                particle.life--;
                return particle.life > 0;
            });
        }

        function updateLoot() {
            game.loot = game.loot.filter(item => {
                item.y += 3;
                return item.y < game.canvas.height;
            });
        }

        function checkCollisions() {
            // تصادم الرصاص مع الأعداء
            game.bullets.forEach((bullet, bulletIndex) => {
                game.enemies.forEach((enemy, enemyIndex) => {
                    if (isColliding(bullet, enemy)) {
                        enemy.health -= bullet.damage;
                        game.bullets.splice(bulletIndex, 1);
                        
                        createExplosion(bullet.x, bullet.y, bullet.color);
                        SoundManager.playExplosion();
                        
                        if (enemy.health <= 0) {
                            game.score += enemy.value;
                            gameData.coins += Math.floor(enemy.value / 2);
                            
                            createLoot(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                            game.enemies.splice(enemyIndex, 1);
                            updateGameUI();
                            showFloatingText(`+${enemy.value} نقاط`, enemy.x, enemy.y, '#fbbf24');
                        }
                    }
                });
                
                // تصادم الرصاص مع البوس
                if (game.bossActive && game.boss && isColliding(bullet, game.boss)) {
                    game.boss.health -= bullet.damage;
                    game.bullets.splice(bulletIndex, 1);
                    
                    createExplosion(bullet.x, bullet.y, '#dc2626');
                    SoundManager.playExplosion();
                    
                    if (game.boss.health <= game.boss.maxHealth - 100 && !game.boss.rewardGiven) {
                        game.boss.rewardGiven = true;
                        grantBossReward();
                    }
                    
                    if (game.boss.health <= 0) {
                        game.score += game.boss.value;
                        gameData.coins += Math.floor(game.boss.value / 2);
                        gameData.gems += 5;
                        
                        createLoot(game.boss.x + game.boss.width / 2, game.boss.y + game.boss.height / 2, true);
                        game.bossActive = false;
                        game.boss = null;
                        
                        updateGameUI();
                        showFloatingText(`+${game.boss.value} نقاط +5 💎`, game.canvas.width/2, game.canvas.height/2, '#fbbf24');
                        
                        setTimeout(() => levelComplete(), 2000);
                    }
                    updateGameUI();
                }
            });

            // تصادم رصاص الأعداء مع اللاعب
            game.enemyBullets.forEach((bullet, bulletIndex) => {
                if (isColliding(bullet, game.player)) {
                    const damage = Math.max(5, bullet.damage - gameData.upgrades.shield);
                    game.player.health -= damage;
                    game.enemyBullets.splice(bulletIndex, 1);
                    createExplosion(bullet.x, bullet.y, bullet.color);
                    SoundManager.playExplosion();
                    
                    updateHealthBar();
                    
                    if (game.player.health <= 0) gameOver();
                }
            });

            // جمع الغنائم
            game.loot.forEach((item, itemIndex) => {
                if (isColliding(item, game.player)) {
                    if (item.type === 'coin') {
                        gameData.coins += item.value;
                        SoundManager.playCoin();
                        showFloatingText(`+${item.value} 💰`, game.player.x, game.player.y, '#fbbf24');
                    } else if (item.type === 'gem') {
                        gameData.gems += item.value;
                        SoundManager.playCoin();
                        showFloatingText(`+${item.value} 💎`, game.player.x, game.player.y, '#e91e63');
                    } else if (item.type === 'health') {
                        game.player.health = Math.min(game.player.maxHealth, game.player.health + 30);
                        showFloatingText('+30 ❤️', game.player.x, game.player.y, '#4caf50');
                        updateHealthBar();
                    } else if (item.type === 'upgrade') {
                        grantBossReward();
                    }
                    
                    game.loot.splice(itemIndex, 1);
                    updateGameUI();
                }
            });
        }

        function grantBossReward() {
            if (!gameData.upgrades.doubleShot) {
                gameData.upgrades.doubleShot = true;
                showFloatingText('🎁 ترقية: طلقة مزدوجة!', game.canvas.width/2, game.canvas.height/2, '#4fc3f7');
                generateUpgrades();
            } else {
                gameData.coins += 200;
                showFloatingText('🎁 +200 عملة!', game.canvas.width/2, game.canvas.height/2, '#fbbf24');
            }
        }

        function isColliding(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 8; i++) {
                game.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 25,
                    maxLife: 25,
                    color: color,
                    size: Math.random() * 12 + 6
                });
            }
        }

        function createLoot(x, y, isBoss = false) {
            const lootTypes = [
                { type: 'coin', chance: 0.7, value: isBoss ? 50 : 5 },
                { type: 'coin', chance: 0.3, value: isBoss ? 100 : 10 },
                { type: 'gem', chance: 0.1, value: isBoss ? 3 : 1 },
                { type: 'health', chance: 0.2, value: 0 }
            ];

            if (isBoss && !gameData.upgrades.doubleShot) {
                lootTypes.push({ type: 'upgrade', chance: 1, value: 0 });
            }

            lootTypes.forEach(loot => {
                if (Math.random() < loot.chance) {
                    game.loot.push({
                        x: x,
                        y: y,
                        width: 25,
                        height: 25,
                        type: loot.type,
                        value: loot.value,
                        color: loot.type === 'coin' ? '#fbbf24' : 
                               loot.type === 'gem' ? '#e91e63' : 
                               loot.type === 'upgrade' ? '#4fc3f7' : '#4caf50'
                    });
                }
            });
        }

        function levelComplete() {
            const baseReward = 50;
            const reward = Math.floor(baseReward * Math.pow(1.5, Math.floor((gameData.currentLevel-1)/5)));
            
            gameData.coins += reward;
            gameData.completedLevels.push(gameData.currentLevel);
            
            if (gameData.currentLevel === gameData.unlockedLevels) {
                gameData.unlockedLevels++;
            }
            
            let message = `🎉 أكملت المستوى ${gameData.currentLevel}!\n\n`;
            message += `النقاط: ${game.score}\n`;
            message += `المكافأة: +${reward} 💰\n\n`;
            
            if (gameData.currentLevel % 10 === 0) {
                message += `🏆 هزمت البوس! +5 💎\n`;
            }
            
            message += `اضغط موافق للمستوى التالي`;
            
            alert(message);
            gameData.currentLevel++;
            showScreen('levelSelectScreen');
        }

        function gameOver() {
            game.isPaused = true;
            if(game.enemySpawnInterval) clearInterval(game.enemySpawnInterval);
            if(game.autoFireInterval) clearInterval(game.autoFireInterval);
            
            const baseReward = 50;
            const levelReward = Math.floor(baseReward * Math.pow(1.5, Math.floor((gameData.currentLevel-1)/5)));
            const scoreReward = Math.floor(game.score / 10);
            const totalReward = levelReward + scoreReward;
            
            gameData.coins += totalReward;
            
            let message = `💀 انتهت اللعبة!\n\n`;
            message += `المستوى: ${gameData.currentLevel}\n`;
            message += `النقاط: ${game.score}\n`;
            message += `المكافأة: +${totalReward} 💰\n\n`;
            message += `حاول مرة أخرى للوصول إلى مستوى أعلى!`;
            
            alert(message);
            showScreen('levelSelectScreen');
        }

        function render() {
            // خلفية متدرجة مع النجوم
            const gradient = game.ctx.createLinearGradient(0, 0, 0, game.canvas.height);
            gradient.addColorStop(0, '#0a0a1a');
            gradient.addColorStop(1, '#1e3a8a');
            game.ctx.fillStyle = gradient;
            game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
            
            // رسم النجوم المتحركة
            game.ctx.fillStyle = '#ffffff';
            game.backgroundStars.forEach(star => {
                game.ctx.beginPath();
                game.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                game.ctx.fill();
            });

            // رسم الغنائم
            game.loot.forEach(item => {
                game.ctx.fillStyle = item.color;
                game.ctx.fillRect(item.x, item.y, item.width, item.height);
                
                // إضافة تأثير لمعان للغنائم
                game.ctx.shadowColor = item.color;
                game.ctx.shadowBlur = 15;
                game.ctx.fillRect(item.x, item.y, item.width, item.height);
                game.ctx.shadowBlur = 0;
            });

            // رسم الجسيمات
            game.particles.forEach(particle => {
                const alpha = particle.life / particle.maxLife;
                game.ctx.save();
                game.ctx.globalAlpha = alpha;
                game.ctx.fillStyle = particle.color;
                game.ctx.shadowColor = particle.color;
                game.ctx.shadowBlur = 10;
                game.ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
                game.ctx.restore();
            });

            // رسم الأعداء مع تأثيرات
            game.enemies.forEach(enemy => {
                // جسم العدو
                game.ctx.fillStyle = enemy.color;
                game.ctx.shadowColor = enemy.color;
                game.ctx.shadowBlur = 15;
                
                if (enemy.stopped) {
                    game.ctx.save();
                    game.ctx.globalAlpha = 0.7 + Math.sin(Date.now() / 200) * 0.3;
                    game.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    game.ctx.restore();
                } else {
                    game.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                }
                game.ctx.shadowBlur = 0;
                
                // شريط الصحة
                const healthPercent = enemy.health / enemy.maxHealth;
                game.ctx.fillStyle = '#ef4444';
                game.ctx.fillRect(enemy.x, enemy.y - 12, enemy.width, 6);
                game.ctx.fillStyle = '#4caf50';
                game.ctx.fillRect(enemy.x, enemy.y - 12, enemy.width * healthPercent, 6);
            });

            // رسم البوس مع تأثيرات
            if (game.bossActive && game.boss) {
                // جسم البوس
                game.ctx.fillStyle = game.boss.color;
                game.ctx.shadowColor = game.boss.color;
                game.ctx.shadowBlur = 25;
                game.ctx.fillRect(game.boss.x, game.boss.y, game.boss.width, game.boss.height);
                game.ctx.shadowBlur = 0;
                
                // عيون البوس
                game.ctx.fillStyle = '#000000';
                game.ctx.fillRect(game.boss.x + 50, game.boss.y + 40, 25, 25);
                game.ctx.fillRect(game.boss.x + game.boss.width - 75, game.boss.y + 40, 25, 25);
                
                // فم البوس
                game.ctx.fillStyle = '#000000';
                game.ctx.fillRect(game.boss.x + 80, game.boss.y + 100, 80, 15);
                
                // شريط صحة البوس
                game.ctx.fillStyle = '#dc2626';
                game.ctx.fillRect(50, 20, game.canvas.width - 100, 25);
                game.ctx.fillStyle = '#4caf50';
                const bossHealthPercent = game.boss.health / game.boss.maxHealth;
                game.ctx.fillRect(50, 20, (game.canvas.width - 100) * bossHealthPercent, 25);
                game.ctx.strokeStyle = '#ffffff';
                game.ctx.lineWidth = 3;
                game.ctx.strokeRect(50, 20, game.canvas.width - 100, 25);
            }

            // رسم رصاص الأعداء
            game.enemyBullets.forEach(bullet => {
                game.ctx.fillStyle = bullet.color;
                game.ctx.shadowColor = bullet.color;
                game.ctx.shadowBlur = 8;
                game.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                game.ctx.shadowBlur = 0;
            });

            // رسم رصاص اللاعب
            game.bullets.forEach(bullet => {
                game.ctx.fillStyle = bullet.color;
                game.ctx.shadowColor = bullet.color;
                game.ctx.shadowBlur = 10;
                game.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                game.ctx.shadowBlur = 0;
            });

            // رسم اللاعب مع تأثيرات
            game.ctx.fillStyle = game.player.color;
            game.ctx.shadowColor = game.player.color;
            game.ctx.shadowBlur = 20;
            game.ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
            game.ctx.shadowBlur = 0;
            
            // تأثيرات خاصة للاعب
            game.ctx.strokeStyle = 'rgba(79, 195, 247, 0.6)';
            game.ctx.lineWidth = 4;
            game.ctx.strokeRect(game.player.x - 4, game.player.y - 4, game.player.width + 8, game.player.height + 8);
        }

        function updateGameUI() {
            document.getElementById('currentScore').textContent = game.score;
            document.getElementById('gameCoins').textContent = gameData.coins;
            document.getElementById('gameGems').textContent = gameData.gems;
        }

        function updateHealthBar() {
            const healthPercent = (game.player.health / game.player.maxHealth) * 100;
            document.getElementById('healthFill').style.width = healthPercent + '%';
        }

        function showFloatingText(text, x, y, color = '#ffffff') {
            const floatingText = document.createElement('div');
            floatingText.className = 'floating-text';
            floatingText.textContent = text;
            floatingText.style.color = color;
            floatingText.style.left = x + 'px';
            floatingText.style.top = y + 'px';
            floatingText.style.fontSize = '24px';
            floatingText.style.fontWeight = 'bold';
            
            document.getElementById('gameScreen').appendChild(floatingText);
            
            setTimeout(() => {
                floatingText.remove();
            }, 2000);
        }

        function pauseGame() {
            game.isPaused = !game.isPaused;
            const btn = document.querySelector('.game-controls .icon-btn');
            if (btn) {
                btn.textContent = game.isPaused ? '▶️' : '⏸️';
            }
            
            if (game.isPaused) {
                SoundManager.stopBackgroundMusic();
            } else {
                SoundManager.playBackgroundMusic();
            }
        }

        function resetGame() {
            if (confirm(gameData.settings.language === 'ar' ? 
                'هل أنت متأكد من إعادة تعيين اللعبة؟ سيتم حذف كل التقدم!' :
                'Are you sure you want to reset the game? All progress will be lost!')) {
                
                gameData = {
                    coins: 1000,
                    gems: 50,
                    currentLevel: 1,
                    unlockedLevels: 1,
                    selectedShip: 'basic',
                    upgrades: {
                        weapon: 1,
                        fireRate: 1,
                        shield: 1,
                        health: 1,
                        doubleShot: false
                    },
                    ships: {
                        basic: { unlocked: true, level: 1 },
                        fighter: { unlocked: false, level: 1 },
                        tank: { unlocked: false, level: 1 },
                        sniper: { unlocked: false, level: 1 }
                    },
                    settings: gameData.settings,
                    completedLevels: []
                };
                
                updateCurrencyDisplay();
                generateLevels();
                generateShips();
                generateUpgrades();
                
                showFloatingText('🔄 تم إعادة تعيين اللعبة', window.innerWidth/2, window.innerHeight/2, '#4caf50');
            }
        }

        // ===== تهيئة اللعبة عند التحميل =====
        window.addEventListener('load', function() {
            console.log('🚀 بدء تحميل Galaxy Attack...');
            
            createStars();
            
            setTimeout(() => {
                try {
                    document.getElementById('loadingScreen').style.display = 'none';
                    showScreen('startScreen');
                    
                    SoundManager.init();
                    updateCurrencyDisplay();
                    generateLevels();
                    generateShips();
                    generateUpgrades();
                    
                    console.log('✅ Galaxy Attack جاهز للانطلاق!');
                    
                } catch (error) {
                    console.error('❌ خطأ في التهيئة:', error);
                    document.getElementById('loadingScreen').innerHTML = `
                        <div class="loading-content">
                            <h2 style="color: #ef4444; font-size: 2em;">❌ خطأ في التحميل</h2>
                            <p style="font-size: 1.2em;">حدث خطأ في تحميل اللعبة</p>
                            <button onclick="location.reload()" style="padding: 15px 30px; background: #6366f1; color: white; border: none; border-radius: 10px; margin-top: 20px; font-size: 1.1em; font-weight: bold;">
                                إعادة تحميل الصفحة
                            </button>
                        </div>
                    `;
                }
            }, 2000);
        });

        window.addEventListener('resize', function() {
            if (game.canvas) {
                game.canvas.width = window.innerWidth;
                game.canvas.height = window.innerHeight;
            }
        });

        // تعريف الدوال العامة
        window.toggleSound = SoundManager.toggleSound.bind(SoundManager);
        window.showScreen = showScreen;
        window.changeLanguage = changeLanguage;
        window.startLevel = startLevel;
        window.selectShip = selectShip;
        window.buyShip = buyShip;
        window.buyUpgrade = buyUpgrade;
        window.pauseGame = pauseGame;
        window.resetGame = resetGame;
    </script>
</body>
</html>
