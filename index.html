<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Attack - Ù„Ø¹Ø¨Ø© space shooter ÙƒØ§Ù…Ù„Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06d6a0;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --boss-color: #dc2626;
            --background: #0f0f23;
            --text-primary: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow: hidden;
            direction: rtl;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª */
        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
        }

        .screen.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .screen-content {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .game-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .player-stats {
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .nav-btn span {
            font-size: 0.6em;
        }

        .nav-btn:hover {
            background: var(--primary-color);
            transform: translateY(-5px);
        }

        .nav-btn.active {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .menu-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            margin: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            background: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .menu-btn.secondary {
            background: rgba(255,255,255,0.1);
        }

        .menu-btn.secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 12px;
            margin: 25px 0;
            max-width: 500px;
        }

        .level-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 15px;
            background: var(--primary-color);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .level-btn.locked {
            background: #666;
            cursor: not-allowed;
        }

        .level-btn.completed {
            background: var(--accent-color);
        }

        .level-btn.current {
            background: var(--secondary-color);
            animation: pulse 2s infinite;
        }

        .level-btn.boss {
            background: var(--boss-color);
            border: 2px solid #ffd54f;
        }

        .level-reward {
            font-size: 0.7em;
            margin-top: 5px;
            color: #ffd54f;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .level-btn:hover:not(.locked) {
            transform: scale(1.1);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .game-ui > * {
            pointer-events: auto;
        }

        .game-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .health-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
            border-radius: 8px;
        }

        .game-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */
        .auto-fire-indicator {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            display: none;
        }

        /* ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¨ÙˆØ³ */
        .boss-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            animation: bossWarning 2s ease-in-out;
            display: none;
        }

        @keyframes bossWarning {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .floating-text {
            position: absolute;
            color: #ffd54f;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (max-width: 768px) {
            .screen-content {
                padding: 20px;
                margin: 10px;
            }
            
            .level-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .level-btn {
                width: 60px;
                height: 60px;
            }
            
            .bottom-nav {
                padding: 10px 15px;
            }
            
            .nav-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
            
            .nav-btn span {
                font-size: 0.5em;
            }
        }

        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© */
        .language-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .lang-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loader"></div>
            <h2>ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Galaxy Attack...</h2>
            <p>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ¶Ø§Ø¡ Ù„Ù„Ù‚ØªØ§Ù„</p>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="startScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span>ğŸ’°</span>
                    <span id="totalCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span>ğŸ’</span>
                    <span id="totalGems">50</span>
                </div>
                <div class="stat-item">
                    <span>â­</span>
                    <span id="playerLevel">1</span>
                </div>
            </div>
            <div class="header-controls">
                <button class="icon-btn" onclick="showScreen('settingsScreen')">âš™ï¸</button>
                <button class="icon-btn" onclick="toggleSound()">ğŸ”Š</button>
            </div>
        </div>

        <div class="screen-content">
            <h1 style="font-size: 3em; margin-bottom: 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ğŸŒŒ Galaxy Attack</h1>
            
            <div class="main-menu">
                <button class="menu-btn" onclick="showScreen('levelSelectScreen')">
                    <span>ğŸ®</span>
                    <span data-lang="ar">Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©</span>
                    <span data-lang="en" style="display: none;">Start Adventure</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('shipsScreen')">
                    <span>ğŸš€</span>
                    <span data-lang="ar">Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ</span>
                    <span data-lang="en" style="display: none;">Space Fleet</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('upgradesScreen')">
                    <span>âš¡</span>
                    <span data-lang="ar">Ù…Ø±ÙƒØ² Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª</span>
                    <span data-lang="en" style="display: none;">Upgrade Center</span>
                </button>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showScreen('startScreen')">
                <span>ğŸ </span>
                <span data-lang="ar">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                <span data-lang="en" style="display: none;">Home</span>
            </button>
            <button class="nav-btn" onclick="showScreen('shipsScreen')">
                <span>ğŸš€</span>
                <span data-lang="ar">Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</span>
                <span data-lang="en" style="display: none;">Fleet</span>
            </button>
            <button class="nav-btn" onclick="showScreen('upgradesScreen')">
                <span>âš¡</span>
                <span data-lang="ar">Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª</span>
                <span data-lang="en" style="display: none;">Upgrades</span>
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ -->
    <div id="levelSelectScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span>ğŸ’°</span>
                    <span id="levelsCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span>ğŸ’</span>
                    <span id="levelsGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">â†</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar">ğŸ¯ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h2>
            <h2 data-lang="en" style="display: none;">ğŸ¯ Select Level</h2>
            <div class="level-grid" id="levelGrid">
                <!-- Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ -->
    <div id="shipsScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span>ğŸ’°</span>
                    <span id="shipsCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span>ğŸ’</span>
                    <span id="shipsGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">â†</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar">ğŸš€ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ</h2>
            <h2 data-lang="en" style="display: none;">ğŸš€ Space Fleet</h2>
            <div id="shipsContainer" style="margin: 20px 0; display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <!-- Ø§Ù„Ø³ÙÙ† Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª -->
    <div id="upgradesScreen" class="screen">
        <div class="game-header">
            <div class="player-stats">
                <div class="stat-item">
                    <span>ğŸ’°</span>
                    <span id="upgradesCoins">1000</span>
                </div>
                <div class="stat-item">
                    <span>ğŸ’</span>
                    <span id="upgradesGems">50</span>
                </div>
            </div>
            <button class="icon-btn" onclick="showScreen('startScreen')">â†</button>
        </div>

        <div class="screen-content">
            <h2 data-lang="ar">âš¡ Ù…Ø±ÙƒØ² Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª</h2>
            <h2 data-lang="en" style="display: none;">âš¡ Upgrade Center</h2>
            <div id="upgradesContainer" style="margin: 20px 0; display: grid; gap: 15px;">
                <!-- Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="gameScreen" class="screen">
        <canvas id="gameCanvas"></canvas>
        
        <div class="game-ui">
            <div class="game-stats">
                <div style="margin-bottom: 8px;">
                    <span data-lang="ar">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span>
                    <span data-lang="en" style="display: none;">Level:</span>
                    <span id="currentLevel">1</span>
                </div>
                <div style="margin-bottom: 8px;">
                    <span data-lang="ar">Ø§Ù„Ù†Ù‚Ø§Ø·:</span>
                    <span data-lang="en" style="display: none;">Score:</span>
                    <span id="currentScore">0</span>
                </div>
                <div>ğŸ’° <span id="gameCoins">0</span> | ğŸ’ <span id="gameGems">0</span></div>
            </div>
            
            <div class="health-bar">
                <div class="health-fill" id="healthFill" style="width: 100%;"></div>
            </div>
            
            <div class="game-controls">
                <button class="icon-btn" onclick="pauseGame()">â¸ï¸</button>
                <button class="icon-btn" onclick="showScreen('startScreen')">ğŸ </button>
            </div>

            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
            <div class="auto-fire-indicator" id="autoFireIndicator">
                <span data-lang="ar">ğŸ”¥ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„</span>
                <span data-lang="en" style="display: none;">ğŸ”¥ Auto Fire Active</span>
            </div>

            <!-- ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¨ÙˆØ³ -->
            <div class="boss-warning" id="bossWarning">
                <span data-lang="ar">âš ï¸ Ø®Ø·Ø±! Ø§Ù„Ø¨ÙˆØ³ Ù‚Ø§Ø¯Ù…</span>
                <span data-lang="en" style="display: none;">âš ï¸ Danger! Boss Incoming</span>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settingsScreen" class="screen">
        <div class="game-header">
            <button class="icon-btn" onclick="showScreen('startScreen')">â†</button>
        </div>
        <div class="screen-content">
            <h2 data-lang="ar">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            <h2 data-lang="en" style="display: none;">âš™ï¸ Settings</h2>
            
            <div class="language-selector">
                <button class="lang-btn active" onclick="changeLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                <button class="lang-btn" onclick="changeLanguage('en')">English</button>
            </div>
            
            <div style="text-align: right; margin: 20px 0;">
                <div style="margin: 15px 0;">
                    <label>ğŸ”Š 
                        <span data-lang="ar">ØµÙˆØª Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª</span>
                        <span data-lang="en" style="display: none;">SFX Volume</span>
                    </label>
                    <input type="range" min="0" max="100" value="80" id="sfxVolume" style="width: 200px;">
                </div>
                <div style="margin: 15px 0;">
                    <label>ğŸµ 
                        <span data-lang="ar">ØµÙˆØª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</span>
                        <span data-lang="en" style="display: none;">Music Volume</span>
                    </label>
                    <input type="range" min="0" max="100" value="60" id="musicVolume" style="width: 200px;">
                </div>
            </div>
            <button class="menu-btn" onclick="resetGame()">
                <span data-lang="ar">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©</span>
                <span data-lang="en" style="display: none;">ğŸ”„ Reset Game</span>
            </button>
        </div>
    </div>

    <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª -->
    <audio id="shootSound" preload="auto" src="sounds/shoot.wav"></audio>
    <audio id="explosionSound" preload="auto" src="sounds/explosion.wav"></audio>
    <audio id="coinSound" preload="auto" src="sounds/coin.wav"></audio>
    <audio id="upgradeSound" preload="auto"></audio>
    <audio id="enemyStopSound" preload="auto"></audio>
    <audio id="backgroundMusic" loop preload="auto" src="sounds/background.mp3"></audio>
    <audio id="bossSound" preload="auto"></audio>

    <script>
        // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© =====
        let gameData = {
            coins: 1000,
            gems: 50,
            currentLevel: 1,
            unlockedLevels: 1,
            selectedShip: 'basic',
            upgrades: {
                weapon: 1,
                fireRate: 1,
                shield: 1,
                health: 1,
                doubleShot: false
            },
            ships: {
                basic: { unlocked: true, level: 1 },
                fighter: { unlocked: false, level: 1 },
                tank: { unlocked: false, level: 1 },
                sniper: { unlocked: false, level: 1 }
            },
            settings: {
                sfxVolume: 80,
                musicVolume: 60,
                soundEnabled: true,
                language: 'ar'
            },
            completedLevels: []
        };

        // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ© =====
        const translations = {
            ar: {
                startAdventure: "Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©",
                spaceFleet: "Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ", 
                upgradeCenter: "Ù…Ø±ÙƒØ² Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª",
                selectLevel: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
                level: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
                score: "Ø§Ù„Ù†Ù‚Ø§Ø·",
                autoFireActive: "Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„",
                bossWarning: "âš ï¸ Ø®Ø·Ø±! Ø§Ù„Ø¨ÙˆØ³ Ù‚Ø§Ø¯Ù…",
                settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                sfxVolume: "ØµÙˆØª Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª",
                musicVolume: "ØµÙˆØª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰",
                resetGame: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©",
                home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
                fleet: "Ø§Ù„Ø£Ø³Ø·ÙˆÙ„",
                upgrades: "Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª"
            },
            en: {
                startAdventure: "Start Adventure",
                spaceFleet: "Space Fleet",
                upgradeCenter: "Upgrade Center", 
                selectLevel: "Select Level",
                level: "Level",
                score: "Score",
                autoFireActive: "Auto Fire Active",
                bossWarning: "âš ï¸ Danger! Boss Incoming",
                settings: "Settings",
                sfxVolume: "SFX Volume",
                musicVolume: "Music Volume",
                resetGame: "Reset Game",
                home: "Home",
                fleet: "Fleet",
                upgrades: "Upgrades"
            }
        };

        function changeLanguage(lang) {
            gameData.settings.language = lang;
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ©
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
            document.querySelectorAll('[data-lang]').forEach(element => {
                if (element.getAttribute('data-lang') === lang) {
                    element.style.display = 'inline';
                } else {
                    element.style.display = 'none';
                }
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
            generateLevels();
        }

        // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© =====
        let game = {
            canvas: null,
            ctx: null,
            player: null,
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            loot: [],
            score: 0,
            isPaused: false,
            lastShot: 0,
            isTouching: false,
            touchX: 0,
            touchY: 0,
            enemySpawnInterval: null,
            autoFireInterval: null,
            boss: null,
            bossActive: false
        };

        // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© =====
        const SoundManager = {
            init() {
                console.log('ğŸ”Š ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ù…Ø¹ Ù…Ù„ÙØ§Øª Freesound...');
                this.setupSoundControls();
            },

            setupSoundControls() {
                const sfxSlider = document.getElementById('sfxVolume');
                const musicSlider = document.getElementById('musicVolume');
                
                if (sfxSlider) {
                    sfxSlider.value = gameData.settings.sfxVolume;
                    sfxSlider.addEventListener('input', (e) => {
                        gameData.settings.sfxVolume = e.target.value;
                    });
                }
                
                if (musicSlider) {
                    musicSlider.value = gameData.settings.musicVolume;
                    musicSlider.addEventListener('input', (e) => {
                        gameData.settings.musicVolume = e.target.value;
                        this.updateMusicVolume();
                    });
                }
            },

            playShoot() {
                if (!gameData.settings.soundEnabled) return;
                
                try {
                    const audio = document.getElementById('shootSound');
                    if (audio) {
                        audio.volume = gameData.settings.sfxVolume / 100;
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚'));
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ ØµÙˆØª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:', error);
                }
            },

            playExplosion() {
                if (!gameData.settings.soundEnabled) return;
                
                try {
                    const audio = document.getElementById('explosionSound');
                    if (audio) {
                        audio.volume = gameData.settings.sfxVolume / 100;
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±'));
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ ØµÙˆØª Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±:', error);
                }
            },

            playCoin() {
                if (!gameData.settings.soundEnabled) return;
                
                try {
                    const audio = document.getElementById('coinSound');
                    if (audio) {
                        audio.volume = gameData.settings.sfxVolume / 100;
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¹Ù…Ù„Ø©'));
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ ØµÙˆØª Ø§Ù„Ø¹Ù…Ù„Ø©:', error);
                }
            },

            playEnemyStop() {
                if (!gameData.settings.soundEnabled) return;
                
                try {
                    const audio = document.getElementById('enemyStopSound');
                    if (audio) {
                        audio.volume = gameData.settings.sfxVolume / 100;
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ùˆ'));
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ ØµÙˆØª ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ùˆ:', error);
                }
            },

            playBackgroundMusic() {
                if (!gameData.settings.soundEnabled) return;
                
                try {
                    const music = document.getElementById('backgroundMusic');
                    if (music) {
                        music.volume = gameData.settings.musicVolume / 100;
                        music.play().catch(e => console.log('Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰'));
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰:', error);
                }
            },

            stopBackgroundMusic() {
                const music = document.getElementById('backgroundMusic');
                if (music) {
                    music.pause();
                    music.currentTime = 0;
                }
            },

            updateMusicVolume() {
                const music = document.getElementById('backgroundMusic');
                if (music) {
                    music.volume = gameData.settings.musicVolume / 100;
                }
            },

            toggleSound() {
                gameData.settings.soundEnabled = !gameData.settings.soundEnabled;
                const btn = document.querySelector('.icon-btn[onclick="toggleSound()"]');
                if (btn) {
                    btn.textContent = gameData.settings.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                }
                
                if (gameData.settings.soundEnabled) {
                    this.playBackgroundMusic();
                } else {
                    this.stopBackgroundMusic();
                }
            }
        };

        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ =====
        function showScreen(screenName) {
            console.log('ğŸ”„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰:', screenName);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.add('active');
                updateScreenContent(screenName);
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (screenName === 'startScreen') {
                document.querySelector('.nav-btn').classList.add('active');
            }
        }

        function updateScreenContent(screenName) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
            updateCurrencyDisplay();
            
            switch(screenName) {
                case 'levelSelectScreen':
                    generateLevels();
                    break;
                case 'shipsScreen':
                    generateShips();
                    break;
                case 'upgradesScreen':
                    generateUpgrades();
                    break;
                case 'gameScreen':
                    startGame();
                    break;
            }
        }

        function updateCurrencyDisplay() {
            document.querySelectorAll('#totalCoins, #levelsCoins, #shipsCoins, #upgradesCoins, #gameCoins').forEach(el => {
                if(el) el.textContent = gameData.coins;
            });
            document.querySelectorAll('#totalGems, #levelsGems, #shipsGems, #upgradesGems, #gameGems').forEach(el => {
                if(el) el.textContent = gameData.gems;
            });
            document.getElementById('playerLevel').textContent = gameData.currentLevel;
        }

        // ===== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ =====
        function generateLevels() {
            const levelGrid = document.getElementById('levelGrid');
            if(!levelGrid) return;
            
            levelGrid.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const levelBtn = document.createElement('button');
                levelBtn.className = 'level-btn';
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (ØªØªØ¶Ø§Ø¹Ù ÙƒÙ„ 5 Ù…Ø³ØªÙˆÙŠØ§Øª)
                const baseReward = 50;
                const reward = baseReward * Math.pow(1.5, Math.floor((i-1)/5));
                
                if (i % 10 === 0) {
                    // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨ÙˆØ³
                    levelBtn.classList.add('boss');
                    levelBtn.innerHTML = `ğŸ‘¹<div class="level-reward">${Math.floor(reward)}ğŸ’°</div>`;
                } else {
                    levelBtn.innerHTML = `${i}<div class="level-reward">${Math.floor(reward)}ğŸ’°</div>`;
                }
                
                if (i > gameData.unlockedLevels) {
                    levelBtn.classList.add('locked');
                    levelBtn.innerHTML = 'ğŸ”’';
                } else if (i === gameData.currentLevel) {
                    levelBtn.classList.add('current');
                } else if (gameData.completedLevels.includes(i)) {
                    levelBtn.classList.add('completed');
                }
                
                if (i <= gameData.unlockedLevels) {
                    levelBtn.onclick = () => startLevel(i);
                }
                
                levelGrid.appendChild(levelBtn);
            }
        }

        // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ£ØªÙŠ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø·ÙˆÙ„
        function generateShips() {
    const shipsContainer = document.getElementById('shipsContainer');
    if(!shipsContainer) return;
    
    shipsContainer.innerHTML = '';
    
    const ships = [
        { id: 'basic', name: 'ğŸš€ Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', price: 0, stats: 'â¤ï¸ 100 âš¡ 8 ğŸ’¥ 25' },
        { id: 'fighter', name: 'ğŸ›¸ Ø§Ù„Ù…Ù‚Ø§ØªÙ„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©', price: 500, stats: 'â¤ï¸ 80 âš¡ 12 ğŸ’¥ 20' },
        { id: 'tank', name: 'ğŸ›¡ï¸ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù„ÙØ¶Ø§Ø¦ÙŠØ©', price: 800, stats: 'â¤ï¸ 200 âš¡ 5 ğŸ’¥ 35' },
        { id: 'sniper', name: 'ğŸ¯ Ø§Ù„Ù‚Ù†Ø§ØµØ©', price: 1200, stats: 'â¤ï¸ 90 âš¡ 7 ğŸ’¥ 60' }
    ];
    
    ships.forEach(ship => {
        const isUnlocked = gameData.ships[ship.id].unlocked;
        const isSelected = gameData.selectedShip === ship.id;
        
        const shipDiv = document.createElement('div');
        shipDiv.style.background = isSelected ? 'rgba(99, 102, 241, 0.2)' : 'rgba(255,255,255,0.1)';
        shipDiv.style.padding = '20px';
        shipDiv.style.borderRadius = '15px';
        shipDiv.style.border = isSelected ? '2px solid #6366f1' : '1px solid rgba(255,255,255,0.2)';
        shipDiv.style.textAlign = 'center';
        
        shipDiv.innerHTML = `
            <h3 style="margin-bottom: 10px;">${ship.name}</h3>
            <p style="color: #ccc; margin-bottom: 10px; font-size: 0.9em;">${ship.stats}</p>
            ${!isUnlocked ? 
                `<p style="color: #ffd54f; margin-bottom: 10px;">Ø§Ù„Ø³Ø¹Ø±: ${ship.price} ğŸ’°</p>
                 <button class="menu-btn" onclick="buyShip('${ship.id}', ${ship.price})" 
                         style="padding: 10px 20px; font-size: 0.9em; min-width: auto;"
                         ${gameData.coins >= ship.price ? '' : 'disabled'}>
                     Ø´Ø±Ø§Ø¡
                 </button>` : 
                `<button class="menu-btn" onclick="selectShip('${ship.id}')" 
                         style="padding: 10px 20px; font-size: 0.9em; min-width: auto; background: ${isSelected ? '#10b981' : '#6366f1'};"
                         ${isSelected ? 'disabled' : ''}>
                     ${isSelected ? 'Ù…Ø­Ø¯Ø¯Ø©' : 'Ø§Ø®ØªÙŠØ§Ø±'}
                 </button>`
            }
        `;
        
        shipsContainer.appendChild(shipDiv);
    });
}

function generateUpgrades() {
    const upgradesContainer = document.getElementById('upgradesContainer');
    if(!upgradesContainer) return;
    
    upgradesContainer.innerHTML = '';
    
    const upgrades = [
        { id: 'weapon', name: 'ğŸ’¥ Ù‚ÙˆØ© Ø§Ù„Ø³Ù„Ø§Ø­', level: gameData.upgrades.weapon, price: 50, desc: 'ÙŠØ²ÙŠØ¯ Ù‚ÙˆØ© Ø§Ù„Ø¶Ø±Ø±' },
        { id: 'fireRate', name: 'ğŸ¯ Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ù„Ù‚Ø§Øª', level: gameData.upgrades.fireRate, price: 75, desc: 'ÙŠØ²ÙŠØ¯ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚' },
        { id: 'shield', name: 'ğŸ›¡ï¸ Ø¯Ø±Ø¹ Ø§Ù„Ø·Ø§Ù‚Ø©', level: gameData.upgrades.shield, price: 100, desc: 'ÙŠÙ‚Ù„Ù„ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„ÙˆØ§Ù‚Ø¹' },
        { id: 'health', name: 'â¤ï¸ ØªØ¹Ø²ÙŠØ² Ø§Ù„ØµØ­Ø©', level: gameData.upgrades.health, price: 150, desc: 'ÙŠØ²ÙŠØ¯ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù‚ØµÙˆÙ‰' }
    ];
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ù‚Ø© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
    if (gameData.upgrades.doubleShot) {
        upgrades.push({
            id: 'doubleShot',
            name: 'ğŸ”« Ø·Ù„Ù‚Ø© Ù…Ø²Ø¯ÙˆØ¬Ø©',
            level: 'Ù…ÙØ¹Ù„',
            price: 0,
            desc: 'Ø¥Ø·Ù„Ø§Ù‚ Ø±ØµØ§ØµØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª'
        });
    }
    
    upgrades.forEach(upgrade => {
        const upgradeDiv = document.createElement('div');
        upgradeDiv.style.background = 'rgba(255,255,255,0.1)';
        upgradeDiv.style.padding = '20px';
        upgradeDiv.style.borderRadius = '15px';
        upgradeDiv.style.display = 'flex';
        upgradeDiv.style.justifyContent = 'space-between';
        upgradeDiv.style.alignItems = 'center';
        upgradeDiv.style.flexWrap = 'wrap';
        upgradeDiv.style.gap = '15px';
        
        const upgradeInfo = document.createElement('div');
        upgradeInfo.style.textAlign = 'right';
        upgradeInfo.innerHTML = `
            <h4 style="margin-bottom: 5px;">${upgrade.name}</h4>
            <p style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">${upgrade.desc}</p>
            <p style="color: #ffd54f;">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${upgrade.level} ${upgrade.price > 0 ? '| Ø§Ù„Ø³Ø¹Ø±: ' + upgrade.price + ' ğŸ’°' : ''}</p>
        `;
        
        const upgradeBtn = document.createElement('button');
        upgradeBtn.className = 'menu-btn';
        upgradeBtn.style.padding = '10px 20px';
        upgradeBtn.style.minWidth = 'auto';
        
        if (upgrade.id === 'doubleShot') {
            upgradeBtn.textContent = 'Ù…ÙØ¹Ù„';
            upgradeBtn.disabled = true;
            upgradeBtn.style.background = '#10b981';
        } else {
            upgradeBtn.textContent = 'ØªØ±Ù‚ÙŠØ©';
            upgradeBtn.onclick = () => buyUpgrade(upgrade.id, upgrade.price);
            upgradeBtn.disabled = gameData.coins < upgrade.price;
        }
        
        upgradeDiv.appendChild(upgradeInfo);
        upgradeDiv.appendChild(upgradeBtn);
        upgradesContainer.appendChild(upgradeDiv);
    });
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© =====
function selectShip(shipId) {
    gameData.selectedShip = shipId;
    generateShips();
    showFloatingText('âœ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ø¦Ø±Ø©!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
}

function buyShip(shipId, price) {
    if (gameData.coins >= price) {
        gameData.coins -= price;
        gameData.ships[shipId].unlocked = true;
        gameData.selectedShip = shipId;
        updateCurrencyDisplay();
        generateShips();
        showFloatingText('âœ“ ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø·Ø§Ø¦Ø±Ø©!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
    }
}

function buyUpgrade(upgradeId, price) {
    if (gameData.coins >= price) {
        gameData.coins -= price;
        gameData.upgrades[upgradeId]++;
        updateCurrencyDisplay();
        generateUpgrades();
        showFloatingText('âœ“ ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©!', window.innerWidth/2, window.innerHeight/2, '#4caf50');
    }
}

function startLevel(level) {
    gameData.currentLevel = level;
    showScreen('gameScreen');
}

// ===== Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆØ³ =====
function startGame() {
    game.canvas = document.getElementById('gameCanvas');
    game.ctx = game.canvas.getContext('2d');
    
    // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
    game.canvas.width = window.innerWidth;
    game.canvas.height = window.innerHeight;
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
    resetGameState();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
    setupPlayer();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ…
    setupControls();
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    gameLoop();
    
    // Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    startEnemySpawning();
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
    SoundManager.playBackgroundMusic();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨ÙˆØ³
    if (gameData.currentLevel % 10 === 0) {
        setTimeout(() => {
            spawnBoss();
        }, 2000);
    }
}

function resetGameState() {
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
    if (game.autoFireInterval) {
        clearInterval(game.autoFireInterval);
    }
    
    game.enemies = [];
    game.bullets = [];
    game.enemyBullets = [];
    game.particles = [];
    game.loot = [];
    game.score = 0;
    game.isPaused = false;
    game.lastShot = 0;
    game.isTouching = false;
    game.boss = null;
    game.bossActive = false;
    
    document.getElementById('currentLevel').textContent = gameData.currentLevel;
    document.getElementById('currentScore').textContent = '0';
    document.getElementById('gameCoins').textContent = '0';
    document.getElementById('gameGems').textContent = '0';
    document.getElementById('healthFill').style.width = '100%';
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('autoFireIndicator').style.display = 'none';
    document.getElementById('bossWarning').style.display = 'none';
}

function setupPlayer() {
    const doubleShotBonus = gameData.upgrades.doubleShot ? 1.5 : 1;
    
    game.player = {
        x: game.canvas.width / 2 - 25,
        y: game.canvas.height - 100,
        width: 50,
        height: 50,
        speed: 8,
        health: 100 + (gameData.upgrades.health * 25),
        maxHealth: 100 + (gameData.upgrades.health * 25),
        color: '#6366f1',
        lastShot: 0,
        fireRate: Math.max(100, 300 - (gameData.upgrades.fireRate * 20)) * doubleShotBonus,
        damage: 25 + (gameData.upgrades.weapon * 15),
        hasDoubleShot: gameData.upgrades.doubleShot
    };
}

function setupControls() {
    // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³ - Ø­Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¥ØµØ¨Ø¹
    game.canvas.addEventListener('touchstart', handleTouchStart);
    game.canvas.addEventListener('touchmove', handleTouchMove);
    game.canvas.addEventListener('touchend', handleTouchEnd);
    
    // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    game.canvas.addEventListener('mousedown', handleMouseDown);
    game.canvas.addEventListener('mousemove', handleMouseMove);
    game.canvas.addEventListener('mouseup', handleMouseUp);
    
    // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ') {
            shoot();
        }
    });
}

function handleTouchStart(e) {
    e.preventDefault();
    game.isTouching = true;
    const touch = e.touches[0];
    updatePlayerPosition(touch.clientX, touch.clientY);
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    startAutoFire();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('autoFireIndicator').style.display = 'block';
}

function handleTouchMove(e) {
    if (!game.isTouching) return;
    e.preventDefault();
    const touch = e.touches[0];
    updatePlayerPosition(touch.clientX, touch.clientY);
}

function handleTouchEnd(e) {
    game.isTouching = false;
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    stopAutoFire();
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('autoFireIndicator').style.display = 'none';
}

function handleMouseDown(e) {
    game.isTouching = true;
    updatePlayerPosition(e.clientX, e.clientY);
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    startAutoFire();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('autoFireIndicator').style.display = 'block';
}

function handleMouseMove(e) {
    if (!game.isTouching) return;
    updatePlayerPosition(e.clientX, e.clientY);
}

function handleMouseUp(e) {
    game.isTouching = false;
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    stopAutoFire();
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('autoFireIndicator').style.display = 'none';
}

function updatePlayerPosition(clientX, clientY) {
    const rect = game.canvas.getBoundingClientRect();
    game.touchX = clientX - rect.left;
    game.touchY = clientY - rect.top;
    
    // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù„Ù…Ø³/Ø§Ù„Ù…Ø¤Ø´Ø±
    game.player.x = game.touchX - game.player.width / 2;
    game.player.y = game.touchY - game.player.height / 2;
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø©
    game.player.x = Math.max(0, Math.min(game.canvas.width - game.player.width, game.player.x));
    game.player.y = Math.max(0, Math.min(game.canvas.height - game.player.height, game.player.y));
}

function startAutoFire() {
    // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± ÙÙˆØ±Ø§Ù‹
    shoot();
    
    // Ø«Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ ÙƒÙ„ ÙØªØ±Ø©
    game.autoFireInterval = setInterval(() => {
        if (game.isTouching && !game.isPaused) {
            shoot();
        }
    }, game.player.fireRate);
}

function stopAutoFire() {
    if (game.autoFireInterval) {
        clearInterval(game.autoFireInterval);
        game.autoFireInterval = null;
    }
}

function shoot() {
    if (Date.now() - game.player.lastShot > game.player.fireRate) {
        if (game.player.hasDoubleShot) {
            // Ø¥Ø·Ù„Ø§Ù‚ Ø±ØµØ§ØµØªÙŠÙ†
            game.bullets.push({
                x: game.player.x + game.player.width / 2 - 15,
                y: game.player.y,
                width: 5,
                height: 15,
                speed: 12,
                damage: game.player.damage,
                color: '#4fc3f7'
            });
            game.bullets.push({
                x: game.player.x + game.player.width / 2 + 10,
                y: game.player.y,
                width: 5,
                height: 15,
                speed: 12,
                damage: game.player.damage,
                color: '#4fc3f7'
            });
        } else {
            // Ø¥Ø·Ù„Ø§Ù‚ Ø±ØµØ§ØµØ© ÙˆØ§Ø­Ø¯Ø©
            game.bullets.push({
                x: game.player.x + game.player.width / 2 - 2.5,
                y: game.player.y,
                width: 5,
                height: 15,
                speed: 12,
                damage: game.player.damage,
                color: '#4fc3f7'
            });
        }

        game.player.lastShot = Date.now();
        SoundManager.playShoot();
    }
}

function gameLoop() {
    if (game.isPaused) {
        requestAnimationFrame(gameLoop);
        return;
    }

    update();
    render();
    requestAnimationFrame(gameLoop);
}

function update() {
    updateBullets();
    updateEnemies();
    updateBoss();
    updateEnemyBullets();
    updateParticles();
    updateLoot();
    checkCollisions();
}

function updateBullets() {
    game.bullets = game.bullets.filter(bullet => {
        bullet.y -= bullet.speed;
        return bullet.y > -bullet.height;
    });
}

function updateEnemies() {
    if (game.bossActive) return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ø£Ø¹Ø¯Ø§Ø¡ Ø¹Ø§Ø¯ÙŠÙŠÙ† Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙˆØ³
    
    // Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    game.enemies.forEach(enemy => {
        if (enemy.stopped) {
            // Ø§Ù„Ø¹Ø¯Ùˆ Ù…ØªÙˆÙ‚Ù
            enemy.stopTimer--;
            if (enemy.stopTimer <= 0) {
                enemy.stopped = false;
                enemy.speed = enemy.originalSpeed;
            }
        } else {
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ø¯Ùˆ
            enemy.y += enemy.speed;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ø¹Ø¯Ùˆ Ø¥Ù„Ù‰ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©
            if (!enemy.hasStopped && enemy.y >= game.canvas.height / 3) {
                enemy.stopped = true;
                enemy.hasStopped = true;
                enemy.stopTimer = 300;
                enemy.speed = 0;
                SoundManager.playEnemyStop();
            }
        }
        
        // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
        if (!enemy.stopped && Math.random() < 0.005) {
            game.enemyBullets.push({
                x: enemy.x + enemy.width / 2 - 2.5,
                y: enemy.y + enemy.height,
                width: 5,
                height: 15,
                speed: 6,
                damage: 10,
                color: '#ef4444'
            });
        }
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø®Ø±Ø¬ÙˆØ§ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
    game.enemies = game.enemies.filter(enemy => enemy.y < game.canvas.height);
}

function updateBoss() {
    if (!game.bossActive || !game.boss) return;
    
    // Ø­Ø±ÙƒØ© Ø§Ù„Ø¨ÙˆØ³
    game.boss.x += game.boss.speedX;
    game.boss.y += game.boss.speedY;
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØ³ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø©
    if (game.boss.x <= 0 || game.boss.x + game.boss.width >= game.canvas.width) {
        game.boss.speedX *= -1;
    }
    if (game.boss.y <= 50 || game.boss.y + game.boss.height >= game.canvas.height / 2) {
        game.boss.speedY *= -1;
    }
    
    // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ù…Ù† Ø§Ù„Ø¨ÙˆØ³
    game.boss.lastShot--;
    if (game.boss.lastShot <= 0) {
        // Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø± Ø¯Ø§Ø¦Ø±ÙŠ
        for (let i = 0; i < 8; i++) {
            const angle = (i / 8) * Math.PI * 2;
            game.enemyBullets.push({
                x: game.boss.x + game.boss.width / 2 - 2.5,
                y: game.boss.y + game.boss.height / 2,
                width: 8,
                height: 8,
                speed: 4,
                damage: 20,
                color: '#dc2626',
                vx: Math.cos(angle) * 4,
                vy: Math.sin(angle) * 4
            });
        }
        game.boss.lastShot = 60; // Ø¥Ø·Ù„Ø§Ù‚ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
    }
}

function updateEnemyBullets() {
    game.enemyBullets = game.enemyBullets.filter(bullet => {
        if (bullet.vx && bullet.vy) {
            // Ø±ØµØ§Øµ Ø§Ù„Ø¨ÙˆØ³ (Ø­Ø±ÙƒØ© ÙÙŠ Ø§ØªØ¬Ø§Ù‡Ø§Øª Ù…Ø®ØªÙ„ÙØ©)
            bullet.x += bullet.vx;
            bullet.y += bullet.vy;
        } else {
            // Ø±ØµØ§Øµ Ø¹Ø§Ø¯ÙŠ
            bullet.y += bullet.speed;
        }
        return bullet.y < game.canvas.height && bullet.y > -bullet.height && 
               bullet.x > -bullet.width && bullet.x < game.canvas.width + bullet.width;
    });
}

function updateParticles() {
    game.particles = game.particles.filter(particle => {
        particle.life--;
        return particle.life > 0;
    });
}

function updateLoot() {
    game.loot = game.loot.filter(item => {
        item.y += 3;
        return item.y < game.canvas.height;
    });
}

function startEnemySpawning() {
    if (game.bossActive) return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ø£Ø¹Ø¯Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙˆØ³
    
    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ø³Ø§Ø¨Ù‚
    if(game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
    
    const spawnRate = Math.max(500, 2000 - (gameData.currentLevel * 50)); // ØªØ²Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø±Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    
    game.enemySpawnInterval = setInterval(() => {
        if (!game.isPaused && !game.bossActive) {
            spawnEnemy();
        }
    }, spawnRate);
}

function spawnEnemy() {
    const level = gameData.currentLevel;
    const enemyTypes = [
        { width: 40, height: 40, health: 30, speed: 1, color: '#ef4444', value: 10 },
        { width: 35, height: 35, health: 20, speed: 1.5, color: '#f59e0b', value: 15 },
        { width: 50, height: 50, health: 50, speed: 0.8, color: '#8b5cf6', value: 25 }
    ];
    
    const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
    const healthMultiplier = 1 + (level * 0.1); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ­Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    
    game.enemies.push({
        x: Math.random() * (game.canvas.width - type.width),
        y: -type.height,
        width: type.width,
        height: type.height,
        health: type.health * healthMultiplier,
        maxHealth: type.health * healthMultiplier,
        speed: type.speed + (level * 0.05),
        originalSpeed: type.speed + (level * 0.05),
        color: type.color,
        value: type.value + (level * 2),
        stopped: false,
        hasStopped: false,
        stopTimer: 0
    });
}

function spawnBoss() {
    game.bossActive = true;
    const level = gameData.currentLevel;
    
    // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¨ÙˆØ³
    const bossWarning = document.getElementById('bossWarning');
    bossWarning.style.display = 'block';
    setTimeout(() => {
        bossWarning.style.display = 'none';
    }, 3000);
    
    game.boss = {
        x: game.canvas.width / 2 - 75,
        y: 50,
        width: 150,
        height: 100,
        health: 500 + (level * 100),
        maxHealth: 500 + (level * 100),
        speedX: 2,
        speedY: 1,
        color: '#dc2626',
        value: 500 + (level * 50),
        lastShot: 0
    };
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
    if (game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
}

function checkCollisions() {
    // ØªØµØ§Ø¯Ù… Ø§Ù„Ø±ØµØ§Øµ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    game.bullets.forEach((bullet, bulletIndex) => {
        // Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
        game.enemies.forEach((enemy, enemyIndex) => {
            if (isColliding(bullet, enemy)) {
                enemy.health -= bullet.damage;
                game.bullets.splice(bulletIndex, 1);
                
                createExplosion(bullet.x, bullet.y, bullet.color);
                SoundManager.playExplosion();
                
                if (enemy.health <= 0) {
                    game.score += enemy.value;
                    gameData.coins += Math.floor(enemy.value / 2);
                    
                    createLoot(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                    
                    game.enemies.splice(enemyIndex, 1);
                    updateGameUI();
                    
                    showFloatingText(`+${enemy.value} Ù†Ù‚Ø§Ø·`, enemy.x, enemy.y, '#ffd54f');
                }
            }
        });
        
        // Ù…Ø¹ Ø§Ù„Ø¨ÙˆØ³
        if (game.bossActive && game.boss && isColliding(bullet, game.boss)) {
            game.boss.health -= bullet.damage;
            game.bullets.splice(bulletIndex, 1);
            
            createExplosion(bullet.x, bullet.y, '#dc2626');
            SoundManager.playExplosion();
            
            // Ù…Ù†Ø­ ØºÙ†ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¶Ø±Ø¨Ø© Ù„Ù„Ø¨ÙˆØ³
            if (game.boss.health <= game.boss.maxHealth - 100 && !game.boss.rewardGiven) {
                game.boss.rewardGiven = true;
                grantBossReward();
            }
            
            if (game.boss.health <= 0) {
                game.score += game.boss.value;
                gameData.coins += Math.floor(game.boss.value / 2);
                gameData.gems += 5;
                
                createLoot(game.boss.x + game.boss.width / 2, game.boss.y + game.boss.height / 2, true);
                game.bossActive = false;
                game.boss = null;
                
                updateGameUI();
                showFloatingText(`+${game.boss.value} Ù†Ù‚Ø§Ø· +5 ğŸ’`, game.canvas.width/2, game.canvas.height/2, '#ffd54f');
                
                // ÙÙˆØ² Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰
                setTimeout(() => {
                    levelComplete();
                }, 2000);
            }
            
            updateGameUI();
        }
    });

    // ØªØµØ§Ø¯Ù… Ø±ØµØ§Øµ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨
    game.enemyBullets.forEach((bullet, bulletIndex) => {
        if (isColliding(bullet, game.player)) {
            const damage = Math.max(5, bullet.damage - gameData.upgrades.shield);
            game.player.health -= damage;
            game.enemyBullets.splice(bulletIndex, 1);
            createExplosion(bullet.x, bullet.y, bullet.color);
            SoundManager.playExplosion();
            
            updateHealthBar();
            
            if (game.player.health <= 0) {
                gameOver();
            }
        }
    });

    // Ø¬Ù…Ø¹ Ø§Ù„ØºÙ†Ø§Ø¦Ù…
    game.loot.forEach((item, itemIndex) => {
        if (isColliding(item, game.player)) {
            if (item.type === 'coin') {
                gameData.coins += item.value;
                SoundManager.playCoin();
                showFloatingText(`+${item.value} ğŸ’°`, game.player.x, game.player.y, '#ffd54f');
            } else if (item.type === 'gem') {
                gameData.gems += item.value;
                SoundManager.playCoin();
                showFloatingText(`+${item.value} ğŸ’`, game.player.x, game.player.y, '#e91e63');
            } else if (item.type === 'health') {
                game.player.health = Math.min(game.player.maxHealth, game.player.health + 30);
                showFloatingText('+30 â¤ï¸', game.player.x, game.player.y, '#4caf50');
                updateHealthBar();
            } else if (item.type === 'upgrade') {
                grantBossReward();
            }
            
            game.loot.splice(itemIndex, 1);
            updateGameUI();
        }
    });
}

function grantBossReward() {
    if (!gameData.upgrades.doubleShot) {
        gameData.upgrades.doubleShot = true;
        showFloatingText('ğŸ ØªØ±Ù‚ÙŠØ©: Ø·Ù„Ù‚Ø© Ù…Ø²Ø¯ÙˆØ¬Ø©!', game.canvas.width/2, game.canvas.height/2, '#4fc3f7');
        generateUpgrades();
    } else {
        gameData.coins += 200;
        showFloatingText('ğŸ +200 Ø¹Ù…Ù„Ø©!', game.canvas.width/2, game.canvas.height/2, '#ffd54f');
    }
}

function isColliding(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
           rect1.x + rect1.width > rect2.x &&
           rect1.y < rect2.y + rect2.height &&
           rect1.y + rect1.height > rect2.y;
}

function createExplosion(x, y, color) {
    for (let i = 0; i < 5; i++) {
        game.particles.push({
            x: x,
            y: y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            life: 20,
            maxLife: 20,
            color: color,
            size: Math.random() * 8 + 4
        });
    }
}

function createLoot(x, y, isBoss = false) {
    const lootTypes = [
        { type: 'coin', chance: 0.7, value: isBoss ? 50 : 5 },
        { type: 'coin', chance: 0.3, value: isBoss ? 100 : 10 },
        { type: 'gem', chance: 0.1, value: isBoss ? 3 : 1 },
        { type: 'health', chance: 0.2, value: 0 }
    ];

    if (isBoss && !gameData.upgrades.doubleShot) {
        lootTypes.push({ type: 'upgrade', chance: 1, value: 0 });
    }

    lootTypes.forEach(loot => {
        if (Math.random() < loot.chance) {
            game.loot.push({
                x: x,
                y: y,
                width: 20,
                height: 20,
                type: loot.type,
                value: loot.value,
                color: loot.type === 'coin' ? '#ffd54f' : 
                       loot.type === 'gem' ? '#e91e63' : 
                       loot.type === 'upgrade' ? '#4fc3f7' : '#4caf50'
            });
        }
    });
}

function levelComplete() {
    const baseReward = 50;
    const reward = Math.floor(baseReward * Math.pow(1.5, Math.floor((gameData.currentLevel-1)/5)));
    
    gameData.coins += reward;
    gameData.completedLevels.push(gameData.currentLevel);
    
    if (gameData.currentLevel === gameData.unlockedLevels) {
        gameData.unlockedLevels++;
    }
    
    let message = `ğŸ‰ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${gameData.currentLevel}!\n\n`;
    message += `Ø§Ù„Ù†Ù‚Ø§Ø·: ${game.score}\n`;
    message += `Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: +${reward} ğŸ’°\n\n`;
    
    if (gameData.currentLevel % 10 === 0) {
        message += `ğŸ† Ù‡Ø²Ù…Øª Ø§Ù„Ø¨ÙˆØ³! +5 ğŸ’\n`;
    }
    
    message += `Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ`;
    
    alert(message);
    
    gameData.currentLevel++;
    showScreen('levelSelectScreen');
}

function render() {
    // Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©
    game.ctx.fillStyle = 'rgba(15, 15, 35, 0.1)';
    game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);

    // Ø±Ø³Ù… Ø§Ù„Ù†Ø¬ÙˆÙ…
    game.ctx.fillStyle = '#ffffff';
    for (let i = 0; i < 100; i++) {
        game.ctx.fillRect(
            Math.random() * game.canvas.width,
            Math.random() * game.canvas.height,
            1, 1
        );
    }

    // Ø±Ø³Ù… Ø§Ù„ØºÙ†Ø§Ø¦Ù…
    game.loot.forEach(item => {
        game.ctx.fillStyle = item.color;
        game.ctx.fillRect(item.x, item.y, item.width, item.height);
    });

    // Ø±Ø³Ù… Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª
    game.particles.forEach(particle => {
        const alpha = particle.life / particle.maxLife;
        game.ctx.save();
        game.ctx.globalAlpha = alpha;
        game.ctx.fillStyle = particle.color;
        game.ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
        game.ctx.restore();
    });

    // Ø±Ø³Ù… Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    game.enemies.forEach(enemy => {
        game.ctx.fillStyle = enemy.color;
        
        // ØªØ£Ø«ÙŠØ± Ø®Ø§Øµ Ù„Ù„Ø¹Ø¯Ùˆ Ø§Ù„Ù…ØªÙˆÙ‚Ù
        if (enemy.stopped) {
            game.ctx.save();
            game.ctx.globalAlpha = 0.7 + Math.sin(Date.now() / 200) * 0.3;
            game.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            game.ctx.restore();
        } else {
            game.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        }
        
        // Ø´Ø±ÙŠØ· Ø§Ù„ØµØ­Ø©
        const healthPercent = enemy.health / enemy.maxHealth;
        game.ctx.fillStyle = '#ef4444';
        game.ctx.fillRect(enemy.x, enemy.y - 8, enemy.width * healthPercent, 4);
    });

    // Ø±Ø³Ù… Ø§Ù„Ø¨ÙˆØ³
    if (game.bossActive && game.boss) {
        game.ctx.fillStyle = game.boss.color;
        game.ctx.fillRect(game.boss.x, game.boss.y, game.boss.width, game.boss.height);
        
        // Ø¹ÙŠÙˆÙ† Ø§Ù„Ø¨ÙˆØ³
        game.ctx.fillStyle = '#000000';
        game.ctx.fillRect(game.boss.x + 30, game.boss.y + 25, 15, 15);
        game.ctx.fillRect(game.boss.x + game.boss.width - 45, game.boss.y + 25, 15, 15);
        
        // ÙÙ… Ø§Ù„Ø¨ÙˆØ³
        game.ctx.fillStyle = '#000000';
        game.ctx.fillRect(game.boss.x + 50, game.boss.y + 60, 50, 10);
        
        // Ø´Ø±ÙŠØ· ØµØ­Ø© Ø§Ù„Ø¨ÙˆØ³
        game.ctx.fillStyle = '#dc2626';
        game.ctx.fillRect(50, 20, game.canvas.width - 100, 20);
        game.ctx.fillStyle = '#4caf50';
        const bossHealthPercent = game.boss.health / game.boss.maxHealth;
        game.ctx.fillRect(50, 20, (game.canvas.width - 100) * bossHealthPercent, 20);
        game.ctx.strokeStyle = '#ffffff';
        game.ctx.lineWidth = 2;
        game.ctx.strokeRect(50, 20, game.canvas.width - 100, 20);
    }

    // Ø±Ø³Ù… Ø±ØµØ§Øµ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    
    game.enemyBullets.forEach(bullet => {
        game.ctx.fillStyle = bullet.color;
        game.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
    });

    // Ø±Ø³Ù… Ø±ØµØ§Øµ Ø§Ù„Ù„Ø§Ø¹Ø¨
    game.bullets.forEach(bullet => {
        game.ctx.fillStyle = bullet.color;
        game.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
    });

    // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
    game.ctx.fillStyle = game.player.color;
    game.ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
    
    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø§Ø¹Ø¨
    game.ctx.strokeStyle = 'rgba(79, 195, 247, 0.5)';
    game.ctx.lineWidth = 2;
    game.ctx.strokeRect(game.player.x - 2, game.player.y - 2, game.player.width + 4, game.player.height + 4);
}

function updateGameUI() {
    document.getElementById('currentScore').textContent = game.score;
    document.getElementById('gameCoins').textContent = gameData.coins;
    document.getElementById('gameGems').textContent = gameData.gems;
}

function updateHealthBar() {
    const healthPercent = (game.player.health / game.player.maxHealth) * 100;
    document.getElementById('healthFill').style.width = healthPercent + '%';
}

function gameOver() {
    game.isPaused = true;
    if(game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
    if(game.autoFireInterval) {
        clearInterval(game.autoFireInterval);
    }
    
    let message = `ğŸ’€ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!\n\n`;
    message += `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${gameData.currentLevel}\n`;
    message += `Ø§Ù„Ù†Ù‚Ø§Ø·:function gameOver() {
    game.isPaused = true;
    if(game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
    if(game.autoFireInterval) {
        clearInterval(game.autoFireInterval);
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    const baseReward = 50;
    const levelReward = Math.floor(baseReward * Math.pow(1.5, Math.floor((gameData.currentLevel-1)/5)));
    const scoreReward = Math.floor(game.score / 10);
    const totalReward = levelReward + scoreReward;
    
    gameData.coins += totalReward;
    
    let message = `ğŸ’€ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!\n\n`;
    message += `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${gameData.currentLevel}\n`;
    message += `Ø§Ù„Ù†Ù‚Ø§Ø·: ${game.score}\n`;
    message += `Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: +${totalReward} ğŸ’°\n\n`;
    message += `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø£Ø¹Ù„Ù‰!`;
    
    alert(message);
    showScreen('levelSelectScreen');
}

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…Ø­Ø³Ù† =====
function calculateLevelReward(level) {
    const baseReward = 50;
    // ØªØ¶Ø§Ø¹Ù Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙƒÙ„ 5 Ù…Ø³ØªÙˆÙŠØ§Øª
    const multiplier = Math.pow(2, Math.floor((level - 1) / 5));
    return Math.floor(baseReward * multiplier);
}

// ===== Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠØ© =====
function getDifficultyMultiplier(level) {
    return 1 + (level * 0.15); // Ø²ÙŠØ§Ø¯Ø© 15% ØµØ¹ÙˆØ¨Ø© Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© spawnEnemy Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„ØµØ¹ÙˆØ¨Ø©
function spawnEnemy() {
    const level = gameData.currentLevel;
    const difficulty = getDifficultyMultiplier(level);
    
    const enemyTypes = [
        { width: 40, height: 40, health: 30, speed: 1, color: '#ef4444', value: 10 },
        { width: 35, height: 35, health: 20, speed: 1.5, color: '#f59e0b', value: 15 },
        { width: 50, height: 50, health: 50, speed: 0.8, color: '#8b5cf6', value: 25 }
    ];
    
    const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
    
    game.enemies.push({
        x: Math.random() * (game.canvas.width - type.width),
        y: -type.height,
        width: type.width,
        height: type.height,
        health: type.health * difficulty,
        maxHealth: type.health * difficulty,
        speed: type.speed * (1 + (level * 0.02)), // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        originalSpeed: type.speed * (1 + (level * 0.02)),
        color: type.color,
        value: Math.floor(type.value * difficulty),
        stopped: false,
        hasStopped: false,
        stopTimer: 0
    });
}

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ­Ø´ Ø§Ù„ÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù† =====
function spawnBoss() {
    game.bossActive = true;
    const level = gameData.currentLevel;
    const difficulty = getDifficultyMultiplier(level);
    
    // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¨ÙˆØ³
    const bossWarning = document.getElementById('bossWarning');
    bossWarning.style.display = 'block';
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    const arText = bossWarning.querySelector('[data-lang="ar"]');
    const enText = bossWarning.querySelector('[data-lang="en"]');
    if (gameData.settings.language === 'ar') {
        arText.style.display = 'inline';
        enText.style.display = 'none';
    } else {
        arText.style.display = 'none';
        enText.style.display = 'inline';
    }
    
    setTimeout(() => {
        bossWarning.style.display = 'none';
    }, 3000);
    
    game.boss = {
        x: game.canvas.width / 2 - 75,
        y: 50,
        width: 150,
        height: 100,
        health: Math.floor(500 * difficulty),
        maxHealth: Math.floor(500 * difficulty),
        speedX: 2 + (level * 0.1),
        speedY: 1 + (level * 0.05),
        color: '#dc2626',
        value: Math.floor(500 * difficulty),
        lastShot: 0,
        rewardGiven: false
    };
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
    if (game.enemySpawnInterval) {
        clearInterval(game.enemySpawnInterval);
    }
}

// ===== ØªØ­Ø³ÙŠÙ† Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
function setupLanguageSettings() {
    const languageSelect = document.getElementById('languageSelect');
    if (languageSelect) {
        languageSelect.value = gameData.settings.language;
        languageSelect.addEventListener('change', (e) => {
            changeLanguage(e.target.value);
        });
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© changeLanguage
function changeLanguage(lang) {
    gameData.settings.language = lang;
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === (lang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'English')) {
            btn.classList.add('active');
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.querySelectorAll('[data-lang]').forEach(element => {
        if (element.getAttribute('data-lang') === lang) {
            element.style.display = 'inline';
        } else {
            element.style.display = 'none';
        }
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    generateLevels();
    generateShips();
    generateUpgrades();
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© =====
function showFloatingText(text, x, y, color = '#ffffff') {
    const floatingText = document.createElement('div');
    floatingText.className = 'floating-text';
    floatingText.textContent = text;
    floatingText.style.color = color;
    floatingText.style.left = x + 'px';
    floatingText.style.top = y + 'px';
    
    document.getElementById('gameScreen').appendChild(floatingText);
    
    setTimeout(() => {
        floatingText.remove();
    }, 1500);
}

function pauseGame() {
    game.isPaused = !game.isPaused;
    const btn = document.querySelector('.game-controls .icon-btn');
    if (btn) {
        btn.textContent = game.isPaused ? 'â–¶ï¸' : 'â¸ï¸';
    }
    
    if (game.isPaused) {
        SoundManager.stopBackgroundMusic();
    } else {
        SoundManager.playBackgroundMusic();
    }
}

function resetGame() {
    if (confirm(gameData.settings.language === 'ar' ? 
        'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…!' :
        'Are you sure you want to reset the game? All progress will be lost!')) {
        
        gameData = {
            coins: 1000,
            gems: 50,
            currentLevel: 1,
            unlockedLevels: 1,
            selectedShip: 'basic',
            upgrades: {
                weapon: 1,
                fireRate: 1,
                shield: 1,
                health: 1,
                doubleShot: false
            },
            ships: {
                basic: { unlocked: true, level: 1 },
                fighter: { unlocked: false, level: 1 },
                tank: { unlocked: false, level: 1 },
                sniper: { unlocked: false, level: 1 }
            },
            settings: gameData.settings, // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            completedLevels: []
        };
        
        updateCurrencyDisplay();
        generateLevels();
        generateShips();
        generateUpgrades();
        
        showFloatingText('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©', window.innerWidth/2, window.innerHeight/2, '#4caf50');
    }
}

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
window.addEventListener('load', function() {
    console.log('ğŸš€ Galaxy Attack Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚!');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
        showScreen('startScreen');
        
        // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª
        SoundManager.init();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©
        setupLanguageSettings();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        updateCurrencyDisplay();
        generateLevels();
        generateShips();
        generateUpgrades();
        
    }, 2000);
});

// Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
window.addEventListener('resize', function() {
    if (game.canvas) {
        game.canvas.width = window.innerWidth;
        game.canvas.height = window.innerHeight;
    }
});

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
window.toggleSound = SoundManager.toggleSound.bind(SoundManager);
window.showScreen = showScreen;
window.changeLanguage = changeLanguage;
window.startLevel = startLevel;
window.selectShip = selectShip;
window.buyShip = buyShip;
window.buyUpgrade = buyUpgrade;
window.pauseGame = pauseGame;
window.resetGame = resetGame;
